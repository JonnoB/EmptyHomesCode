---
title: "Untitled"
author: "Jonathan Bourne"
date: "10 February 2017"
output: html_document
---

#references

The key data is the ONS postcode directory. This data is released quarterly, and contains all the postcode past and present.
This data set is great as it matches the postcodes to LSOA which makes the whole geospatial part much easier.

The other two data sets are the regional code look up

and the ward look up. Ward data can be found by searching the ONS open geograph portal. the name of the dataset is similar too "Lower Layer Super Output Area (2011) to Ward (2018) Lookup in England and Wales v3" this dataset is updated regulalry as well the most recent should be used.

This code is greatly simplified from earlier versions due to switching to the ONSPD and removeing the mapping experiments.

GEOGRAPHIC LESCENSING FROM ONS remember to use!
https://www.ons.gov.uk/methodology/geography/licences

The lookup to convert from Local authority code to name and region code and name is found here
http://ons.maps.arcgis.com/home/item.html?id=17a30c262cf44ad0b9780d97c5d4a856


Number of households of size x with bedrooms y
https://www.nomisweb.co.uk/census/2011/lc4405ew




```{r}
basewd <-"~/Dropbox/SSE/Empty Homes"
ONSpostcodes <- file.path(basewd, "ONSPD")
AddGeog <- file.path(basewd, "AdditionalGeographies")
wards_file <- "Lower_Layer_Super_Output_Area_2011_to_Ward_2018_Lookup_in_England_and_Wales_v3.csv"
Regions <- file.path(basewd, "Regions")

select <- dplyr::select

Wardnames <- read_csv(file.path(AddGeog, wards_file)) 

LADReg <- read.csv(file.path( AddGeog, "LAD15_RGN15_EN_LU.csv"), stringsAsFactors = FALSE   )

CorePstCd  <- read_csv(file.path(ONSpostcodes, 
                              "ONSPD_FEB_2019_UK.csv")) %>%
  select(Postcode = pcd, LSOA11CD = lsoa11, 
         MSOA11CD = msoa11, LAD11CD = oslaua, 
         OA11CD = oa11, Country_code = ctry, 
         Region =  rgn)

{
PstCdLSOA <- CorePstCd %>% 
  left_join(., LADReg, by = c("LAD11CD"="LAD15CD")) %>%
  left_join(Wardnames, by = "LSOA11CD") %>%
  #filter(Country_code == "W92000004")
  select(Postcode, Country_code, Admin_district_code = LAD11CD, 
         Admin_ward_code = WD18CD, lsoa11cd = LSOA11CD, LAD15NM = LAD18NM, 
         RGN15CD, RGN15NM, WD16NM = WD18NM) %>%
  mutate(
    #Make sure Scotland and Wales have region names
    RGN15CD = case_when(
      grepl("W", Country_code) ~"Wales",
      grepl("S", Country_code) ~"Scotland",
      TRUE ~ RGN15CD),
    RGN15NM = case_when(
      grepl("W", Country_code) ~"Wales",
      grepl("S", Country_code) ~"Scotland",
      TRUE ~ RGN15NM
    ),
    Postcode = gsub(" ", "", Postcode)) %>% #remove spaces from postcodes
filter(!is.na(RGN15NM),
       LAD15NM != "NA",
       RGN15CD !="Scotland")
#This is a large dataframe so we want to remove it when possible to save memory

#region cleaning
#some LSOA are in multiple regions and Adminwards this code fixes this by using a majority vote

MajRegion <- PstCdLSOA  %>% group_by(lsoa11cd, RGN15CD) %>%
  summarise(count = n(),
            RGN15NM = first(RGN15NM)) %>%
  group_by(lsoa11cd) %>%
  arrange(-count) %>%
  summarise_all(first) %>%
  select(-count)

MajLAD <- PstCdLSOA  %>% group_by(lsoa11cd, Admin_district_code) %>%
  summarise(count = n()) %>%
  group_by(lsoa11cd) %>%
  arrange(-count) %>%
  summarise_all(first) %>%
  select(-count)

PstCdLSOA  <- PstCdLSOA %>%
  select(-Admin_district_code,-RGN15CD, -RGN15NM) %>%
  left_join(MajLAD) %>%
  left_join(MajRegion)
}

rm(CorePstCd)


```


Create a script that cycles through and creates a folder for each region and then generates the excel sheet for each LAD within each region. This allows the excel spreadsheet for different parts of the country to be found more easily.
```{r}

unique(PstCdLSOA$RGN15NM) %>%
  walk(~{
    
    title <- paste("Region", .x)
    dir.create(file.path(Regions, title ), showWarnings = FALSE)
    #The inner loop creates the excel files for each LAD within each region
    PstCdLSOA.Reg <- PstCdLSOA %>% filter(RGN15NM == .x)
    
    print(title)
    
    unique(PstCdLSOA.Reg$LAD15NM) %>%
      walk(~{
        
        PstCdLSOA.filt <- PstCdLSOA.Reg %>% filter(LAD15NM == .x)
        print(paste(title, ":", .x))
        ExemptionsFile <- paste0(.x,"ExemptionsLSOA.xlsx")
        DiscountsFile <- paste0(.x,"DiscountsLSOA.xlsx")
        setwd(basewd)
        wb <- loadWorkbook("Convert Postcode to LSOA.xlsx")
        #input the LSOA lookup table
        writeData(wb, sheet = "LSOAdata", PstCdLSOA.filt, colNames = T)
        #add in randomly sampled postcodes as an example
        writeData(wb, sheet = "Input", sample(PstCdLSOA.filt$Postcode, 6),
                  startCol = 2, startRow = 2,
                  colNames = F)
        setwd(file.path(Regions, title))
        saveWorkbook(wb,ExemptionsFile ,overwrite = T)
        writeData(wb, "Input", "Discount_Class") #So that it says Discounts not exemptions, so nobody gets confused.
        saveWorkbook(wb,DiscountsFile ,overwrite = T)
        
      })
    
  })

```



