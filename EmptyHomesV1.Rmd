---
title: "Empty Homes V1"
author: "Jonathan Bourne"
date: "10 February 2017"
output: html_document
---

It would have been sensible to separate council and private housing

PCLB0 is second homes, PCLC0 is long term empty, PCLC100 is empty and unfurnished up to six months and PCLD100 is undergoing major repairs up to 12 months.  

#Telegraph article on pensioners requireing mortgages
http://www.telegraph.co.uk/personal-banking/mortgages/pensioner-mortgages-boom-britains-broken-housing-market/

Mean household income 31920
https://www.ons.gov.uk/peoplepopulationandcommunity/personalandhouseholdfinances/incomeandwealth/datasets/nowcastinghouseholdincomeintheuk

```{r setup}
setwd( "~/Dropbox/SSE/Empty Homes/EmptyHomesCode/SubCode")
source("Setup.R")

setwd(Functions)
list.files() %>% map(source)
```

#VOA data

Council tax bands from VOA
https://www.gov.uk/government/statistics/council-tax-stock-of-properties-2016

```{r PopandHomes}
setwd(DataFolder)

CTtaxstock<- read_csv("Table_CTSOP1.1_2016.csv")

pop <- read_csv("SAPE2.csv")

EW <- inner_join(select(CTtaxstock, ECODE, ALL_PROPERTIES),select(pop, `Area Codes`, `All Ages`),
          by=c("ECODE" = "Area Codes")) %>% setNames(c("ECODE", "Homes", "Pop")) 
```

#Load the LSOA shape data for EW 

```{r}
setwd(LSOAshapedata)

shape <- readOGR(dsn = list.files(pattern = "shp"))

```



# Load Post code data

This chunk checks the exiatane of the postcode to lsoa lookup if it doesn't find it, the second part of the code is run that creates the lookup. Creating the lookup takes quite a lot of time so it is good to only have to do it once.
```{r}

if(file.exists(file.path(DataFolder,"PstCdLSOA.rds"))){
 PstCdLSOA.raw <- readRDS(file.path(DataFolder,"PstCdLSOA.rds"))
} else {
  source(file.path(CommonCode, "PostcodeLookup.R"))
}

```


Bind the ward names and LAD names to the lsoa data
```{r LAD/WARD data}
setwd(PostcodeLookups)
lsoa <- read_csv("PCD11_OA11_LSOA11_MSOA11_LAD11_EW_LU_aligned_v2.csv") %>%
  select(LSOA11CD:LAD11NMW) %>% distinct(., LSOA11CD, .keep_all = TRUE)

setwd(AddGeog)
wardnames <- read_csv("Ward_to_Local_Authority_District_to_County_to_Region_to_Country_December_2016_Lookup_in_United_Kingdom_V2.csv") %>% setNames(c("Admin_ward_code", names(.)[-1]))

#uses the dataframe from the CreateExceltemplates to get the ward names and the lsoa together
wardlsoa <- PstCdLSOA.raw %>% distinct(lsoa11cd, .keep_all = TRUE) %>% 
  select(lsoa11cd, Admin_ward_code)

EW2 <- inner_join(EW, lsoa, by = c("ECODE" = "LSOA11CD") ) %>% 
      left_join(., wardlsoa, by = c("ECODE"="lsoa11cd") ) %>% 
  left_join(., select(wardnames, Admin_ward_code, WD16NM), by = "Admin_ward_code") %>%
  group_by(Admin_ward_code) %>%
  mutate(WardHomes = sum(Homes),  WardPop = sum(Pop)) %>% ungroup
rm(wardlsoa)
rm(wardnames)
```

Convert shape file to dataframe and join in the LSOA data
```{r}

if(file.exists(file.path(DataFolder,"shapeframe.rds"))){
 AG<- readRDS(file.path(DataFolder,"shapeframe.rds"))
} else{
    setwd(LSOAshapedata)

    shape <- readOGR(dsn = list.files(pattern = "shp"))
  
    AG <- fortify(shape, region = "objectid")

    AG <- AG %>% mutate(id = as.integer(id)) %>% 
      left_join(., shape@data, by = c("id" = "objectid")) %>% 
    left_join(., EW2, by = c("lsoa11cd" = "ECODE"))
    
    saveRDS(AG, file.path(DataFolder,"shapeframe.rds"))
    }

```

#I should probably join the homes and pop at the same time I join the council tax data


#get prices

```{r}

setwd(DataFolder)

prices <-read_csv("pp-2016.csv", col_names = FALSE ) %>% 
  mutate(X4 = gsub(" ", "", X4)) %>% 
  left_join(., PstCdLSOA.raw %>% mutate(Postcode = gsub(" ", "", Postcode)), 
            by = c("X4"="Postcode")) %>% 
  filter(!is.na(lsoa11cd)) %>% mutate(Prime = X2>1e6, SuperPrime = X2>1e7)

MeanWardPrice <- prices %>% 
  group_by(Admin_ward_code) %>% 
  summarise( MeanPrice = mean(X2), 
             MedianPrice = median(X2),counts =n(),  
             Prime = sum(Prime), 
             SuperPrime = sum(SuperPrime)) %>% 
  mutate(TotPrime = Prime/sum(Prime), TotSupPrime = SuperPrime/sum(SuperPrime),
         PrimePerc = Prime/counts, SuperPrimePerc = SuperPrime/counts)

MeanWardPrice %>% ggplot(., aes(x= counts)) + geom_density()

WardDat2 <- WardDat %>% left_join(., MeanWardPrice) %>% mutate(vallow = LowUse*MeanPrice) %>%
  filter(!is.na(MeanPrice)) 


setwd(DataFolder)
list.files()

#Unnfordability at EW level salery 2014-2015
mean(prices$X2)/31920

#is mean income estimates
IncomeEst <- read_excel("1smallareaincomeestimatesdataupdate.xls", sheet = 4, skip = 4) %>%
  setNames(make.names(names(.)) %>% 
             gsub("\\.(?=\\.*$)", "", ., perl=TRUE)) #removes trailing full stop.

test2 <- prices %>% left_join(., select(EW2, ECODE, MSOA11CD), 
                              by =c("lsoa11cd"="ECODE")) %>%
  group_by(MSOA11CD) %>%
  summarise(MeanPrice = mean(X2), counts = n()) %>%
  left_join(., IncomeEst, by=c("MSOA11CD"= "MSOA.code")) %>%
  mutate(Yearly.income= 52 * Total.weekly.income, ratio = MeanPrice/Yearly.income)

test2 %>% ggplot(.,aes(x=ratio)) +geom_density()

sum(test2$ratio>6)/nrow(test2)  #about 50% EW
test2 %>% filter(Region.name == "London") %>% mutate(HighRatio = ratio>10) %>%
  summarise(total = sum(HighRatio)/n())


```


# Using the full data

```{r}
#Lambeth

setwd(file.path(RegionsComp, "Region London"))

Lam2 <- read_excel("LambethExemptionsLSOA.xlsx")[,1:4] %>%  
    StructureData(., lowuse = c(2:5,24,25), empty =  c(4:5,24,25))

Lambeth <- read_excel("LambethExemptionsLSOA.xlsx")[,1:4] %>%
  setNames(make.names(names(.))) %>%
  group_by(Exemption.type, LSOA_CODE) %>% 
  summarise(Counts = n()) %>% 
  spread(., Exemption.type, Counts, fill = 0) %>%
    setNames(make.names(names(.))) %>%
  mutate(LowUse = rowSums(.[,c(2:5, 24:25)]), Empty = LowUse - Empty.Class.A-Empty.Class.B) %>%
   left_join(., EW2, by = c("LSOA_CODE" = "ECODE"))

LAMDAT <- AG %>% filter(LAD11NM == "Lambeth") %>% 
  left_join(., select(Lambeth, LSOA_CODE, LowUse, Empty), by = c("lsoa11cd" = "LSOA_CODE"))

#Islington

Islington <- read_csv("IslingtonExemptionsLSOA as at 2017 03 24.csv"  )[1:4] %>% setNames(make.names(names(.))) %>%
  group_by(Exemption.type, LSOA_CODE) %>% 
  summarise(Counts = n()) %>% 
  spread(., Exemption.type, Counts, fill = 0) %>%
    setNames(make.names(names(.))) %>%
  mutate(LowUse = rowSums(.[,-c(1,12,13)]), Empty = LowUse ) %>%
   left_join(., EW2, by = c("LSOA_CODE" = "ECODE"))

ISL2 <- Islington %>% mutate(LowUsePerc = LowUse/Homes)

ISLDAT <- AG %>% filter(LAD11NM == "Islington") %>% 
  left_join(., select(Islington, LSOA_CODE, LowUse, Empty), by = c("lsoa11cd" = "LSOA_CODE"))



#Greenwhich
list.files()
wardnames %>% filter(grepl("city", LAD11NM)) 

Greenwich <- read_excel( "Royal Borough Of Greenwich.xlsx")[1:4] %>% setNames(make.names(names(.))) %>%
  group_by(Exemption.type, LSOA_CODE) %>% 
  summarise(Counts = n()) %>% ungroup %>%
  mutate(Exemption.type = trimws(Exemption.type))  %>%
  spread(., Exemption.type, Counts, fill = 0) %>%
    setNames(make.names(names(.))) %>%
  mutate(LowUse = rowSums(.[,c(2,3,4,21,22)]), Empty = LowUse -  EMPTY.CLASS.B) %>%
   left_join(., EW2, by = c("LSOA_CODE" = "ECODE"))

Greenwhich2 <- Greenwich %>% mutate(LowUsePerc = signif(LowUse/Homes*100,3))
  
GREDAT <- AG %>% filter(grepl("Greenwich", LAD11NM)) %>% left_join(., select(Greenwich, Admin_ward_code, LowUse, Empty))



#Camden

test <- read.xlsx("Camden Exemptions LSOA - 20891480.xlsx")[1:4]

Camden <- read.xlsx("Camden Discounts LSOA - 20891480.xlsx" )[,1:4] %>%
  group_by(Discount.type, LSOA_CODE) %>% 
  summarise(Counts = n()) %>% 
  spread(., Discount.type, Counts, fill = 0) %>% 
  mutate(LowUse = rowSums(.[,-1]), Empty = LowUse - B) %>%
   left_join(., EW2, by = c("LSOA_CODE" = "ECODE"))

CAMDAT <- AG %>% filter(LAD11NM == "Camden") %>% 
  left_join(., select(Camden, LSOA_CODE, LowUse, Empty), by = c("lsoa11cd" = "LSOA_CODE"))

#Bromley

Bromley <- read.xlsx("Copy of BromleyExemptionsLSOA.xlsx")[,1:4] %>%
  setNames(make.names(names(.))) %>%
  group_by(Exemption.type, LSOA_CODE) %>% 
  summarise(Counts = n()) %>% 
  spread(., Exemption.type, Counts, fill = 0) %>%
    setNames(make.names(names(.))) %>%
  mutate(LowUse = rowSums(.[,c(6:8,29:31)]), Empty=LowUse - Empty.Class.B) %>%
   left_join(., EW2, by = c("LSOA_CODE" = "ECODE"))

BRODAT <- AG %>% filter(LAD11NM == "Bromley") %>% 
  left_join(., select(Bromley, LSOA_CODE, LowUse, Empty), by = c("lsoa11cd" = "LSOA_CODE"))


#Haringey

Haringey <- read.xlsx("Haringey_Exemptions_Discounts_LSOA.xlsx")[c(1,3,5)] %>%
    setNames(make.names(names(.))) %>%
  group_by(Exemption...Discount.type, LSOA_CODE) %>% 
  summarise(Counts = n()) %>%
  spread(., key = Exemption...Discount.type, 
         value = Counts, fill = 0) %>%
    setNames(make.names(names(.))) %>%
  mutate(LowUse = rowSums(.[,21:25]), Empty=LowUse - PCLB0) %>%
   left_join(., EW2, by = c("LSOA_CODE" = "ECODE"))

HARDAT <- AG %>% filter(LAD11NM == "Haringey") %>% 
  left_join(., select(Haringey, LSOA_CODE, LowUse, Empty), by = c("lsoa11cd" = "LSOA_CODE"))


#Sutton

Sutton <- read_excel("SuttonExemptionsLSOADiscount.xlsx"  )[,1:6] %>%
    setNames(make.names(names(.))) %>%
  group_by(Exemption.type, LSOA_CODE) %>% 
  summarise(Counts = n()) %>%
  spread(., key = Exemption.type, 
         value = Counts, fill = 0) %>%
    setNames(make.names(names(.)))%>%
  mutate(LowUse = rowSums(.[,-1]), Empty=LowUse - PCLB0) %>%
   left_join(., EW2, by = c("LSOA_CODE" = "ECODE")) 

SUTDAT <- AG %>% filter(LAD11NM == "Sutton") %>% 
  left_join(., select(Sutton, LSOA_CODE, LowUse, Empty), by = c("lsoa11cd" = "LSOA_CODE"))



#Richmond

Richmond <- read_csv("Richmond_2.csv" )[1:4] %>% setNames(make.names(names(.))) %>%
  rename(Exemption.type = Discount.type) %>%
  mutate(Exemption.type = Exemption.type %>% trimws %>%
           make.names %>% 
           gsub("\\.{2,}" , ".", .)) %>%
  group_by(Exemption.type, LSOA_CODE) %>% summarise(counts = n()) %>% 
  spread(key= Exemption.type, value = counts, fill = 0) %>% 
    setNames(make.names(trimws(names(.)))) %>%
    mutate(LowUse = rowSums(.[,-1]), Empty = LowUse) %>%
  left_join(., EW2, by = c("LSOA_CODE" = "ECODE")) %>% group_by(Admin_ward_code)  %>%
  mutate(LowUsePerc = LowUse/Homes, WardLowUse = sum(LowUse) ,WardLowUsePerc = WardLowUse/WardHomes) %>% ungroup %>% left_join(., MeanWardPrice) %>% mutate(ValLow = LowUse*MeanPrice)


RICDAT <- AG %>% filter(LAD11NM == "Richmond upon Thames") %>% 
  left_join(., select(Richmond, LSOA_CODE, LowUse, Empty), by = c("lsoa11cd" = "LSOA_CODE"))

#Hillingdon

Hillingdon <- read.xlsx("HillingdonDiscountsLSOA.XLSX" )[1:4] %>% mutate(Exemption.type = Exemption.type %>% trimws %>%
           make.names %>% 
           gsub("\\.{2,}" , ".", .)) %>%
  group_by(Exemption.type, LSOA_CODE) %>% summarise(counts = n()) %>% 
  spread(key= Exemption.type, value = counts, fill = 0) %>% 
    setNames(make.names(trimws(names(.)))) %>%  
  mutate(LowUse = rowSums(.[,-1]), Empty = LowUse- Class.B.Second.Home) %>%
  left_join(., EW2, by = c("LSOA_CODE" = "ECODE")) %>% group_by(Admin_ward_code)  %>%
  mutate(LowUsePerc = LowUse/Homes, WardLowUse = sum(LowUse) ,WardLowUsePerc = WardLowUse/WardHomes) %>% ungroup %>% left_join(., MeanWardPrice) %>% mutate(ValLow = LowUse*MeanPrice)

HILDAT <- AG %>% filter(LAD11NM == "Hillingdon") %>% 
  left_join(., select(Hillingdon, LSOA_CODE, LowUse, Empty), by = c("lsoa11cd" = "LSOA_CODE"))


#Bexley

Bexley <- read.xlsx( "Bexley Exemptions.xlsx" , colNames = FALSE) %>%
  setNames(c("Exemption.type", "LSOA_CODE", "X3", "X4")) %>%
  group_by(Exemption.type, LSOA_CODE) %>% summarise(counts = n()) %>% 
  spread(key= Exemption.type, value = counts, fill = 0) %>% 
    setNames(make.names(trimws(names(.)))) %>% 
  mutate(LowUse = rowSums(.[,c(2,19,20)]), Empty = LowUse) %>%
  left_join(., EW2, by = c("LSOA_CODE" = "ECODE")) %>% group_by(Admin_ward_code)  %>%
  mutate(LowUsePerc = LowUse/Homes, WardLowUse = sum(LowUse) ,WardLowUsePerc = WardLowUse/WardHomes) %>% ungroup %>% left_join(., MeanWardPrice) %>% mutate(ValLow = LowUse*MeanPrice)
  
BEXDAT <- AG %>% filter(LAD11NM == "Bexley") %>% 
  left_join(., select(Bexley, LSOA_CODE, LowUse, Empty), by = c("lsoa11cd" = "LSOA_CODE"))
  
#RBKC

Chelsea <- read.xlsx( "Kensington and ChelseaDiscountsLSOA.xlsx" , colNames = TRUE) %>%
  setNames(c("Exemption.type", "LSOA_CODE", "X3", "X4")) %>%
  group_by(Exemption.type, LSOA_CODE) %>% summarise(counts = n()) %>% 
  spread(key= Exemption.type, value = counts, fill = 0) %>% 
    setNames(make.names(trimws(names(.)))) %>% 
  mutate(LowUse = rowSums(.[,-1]), Empty = LowUse) %>%
  left_join(., EW2, by = c("LSOA_CODE" = "ECODE")) %>% group_by(Admin_ward_code)  %>%
  mutate(LowUsePerc = LowUse/Homes, WardLowUse = sum(LowUse) ,WardLowUsePerc = WardLowUse/WardHomes) %>% ungroup %>% left_join(., MeanWardPrice) %>% mutate(ValLow = LowUse*MeanPrice) 


CHELDAT <-  AG %>% filter(grepl("Kensington", LAD11NM))%>% left_join(., select(Chelsea, Admin_ward_code, LowUse, Empty)) %>% 
  filter(WD16NM!= "Kensal Green")
  
#Barking
Bark <- read.xlsx( "Barking and DagenhamExemptionsLSOA v3.xlsx" , colNames = FALSE) %>%
  setNames(c("Exemption.type", "LSOA_CODE", "X3", "X4")) %>%
  group_by(Exemption.type, LSOA_CODE) %>% summarise(counts = n()) %>% 
  spread(key= Exemption.type, value = counts, fill = 0) %>% 
    setNames(make.names(trimws(names(.)))) %>% 
  mutate(LowUse = rowSums(.[,c(2,3,6,7)]), Empty = LowUse) %>%
  left_join(., EW2, by = c("LSOA_CODE" = "ECODE")) %>% group_by(Admin_ward_code)  %>%
  mutate(LowUsePerc = LowUse/Homes, WardLowUse = sum(LowUse) ,WardLowUsePerc = WardLowUse/WardHomes) %>% ungroup %>% left_join(., MeanWardPrice) %>% mutate(ValLow = LowUse*MeanPrice)
  
BARKDAT <- AG %>% filter(LAD11NM == "Barking and Dagenham") %>% 
  left_join(., select(Bark, LSOA_CODE, LowUse, Empty), by = c("lsoa11cd" = "LSOA_CODE"))
  

#Barnet

Barnet <- read.xlsx( "3386297 Attachment BarnetDiscounts.xlsx"  , colNames = TRUE) %>%
  setNames(c("ExemAG %>% filter(grepl("Kensington", LAD11NM))%>% left_join(., select(Chelsea, Admin_ward_code, LowUse, Empty)) %>% 
  filter(WD16NM!= "Kensal Green")AG %>% filter(grepl("Kensington", LAD11NM))%>% left_join(., select(Chelsea, Admin_ward_code, LowUse, Empty)) %>% 
  filter(WD16NM!= "Kensal Green")AG %>% filter(grepl("Kensington", LAD11NM))%>% left_join(., select(Chelsea, Admin_ward_code, LowUse, Empty)) %>% 
  filter(WD16NM!= "Kensal Green")ption.type", "LSOA_CODE", "X3", "X4")) %>%
  group_by(Exemption.type, LSOA_CODE) %>% summarise(counts = n()) %>% 
  spread(key= Exemption.type, value = counts, fill = 0) %>% 
    setNames(make.names(trimws(names(.)))) %>% 
  mutate(LowUse = rowSums(.[,c(2:8)]), Empty = LowUse) %>%
  left_join(., EW2, by = c("LSOA_CODE" = "ECODE")) %>% group_by(Admin_ward_code)  %>%
  mutate(LowUsePerc = LowUse/Homes, WardLowUse = sum(LowUse) ,WardLowUsePerc = WardLowUse/WardHomes) %>% ungroup %>% left_join(., MeanWardPrice) %>% mutate(ValLow = LowUse*MeanPrice)

BARNDAT <- AG %>% filter(LAD11NM == "Barnet") %>% 
  left_join(., select(Barnet, LSOA_CODE, LowUse, Empty), by = c("lsoa11cd" = "LSOA_CODE"))
  

#Newham

Newham <- read.xlsx( "NewhamExemptionsLSOA.XLSX"  , colNames = TRUE) %>%
  setNames(c("Exemption.type", "LSOA_CODE", "X3", "X4")) %>%
  group_by(Exemption.type, LSOA_CODE) %>% summarise(counts = n()) %>% 
  spread(key= Exemption.type, value = counts, fill = 0) %>% 
    setNames(make.names(trimws(names(.)))) %>% 
  mutate(LowUse = rowSums(.[,c(2)]), Empty = LowUse) %>%
  left_join(., EW2, by = c("LSOA_CODE" = "ECODE")) %>% group_by(Admin_ward_code)  %>%
  mutate(LowUsePerc = LowUse/Homes, WardLowUse = sum(LowUse) ,WardLowUsePerc = WardLowUse/WardHomes) %>% ungroup %>% left_join(., MeanWardPrice) %>% mutate(ValLow = LowUse*MeanPrice)

BARNDAT <- AG %>% filter(LAD11NM == "Barnet") %>% 
  left_join(., select(Barnet, LSOA_CODE, LowUse, Empty), by = c("lsoa11cd" = "LSOA_CODE"))
  

```


#Semi data 
```{r}
#ward folder
setwd(SemiLondon)
list.files()

wardnames <- EW2 %>% group_by(Admin_ward_code, WD16NM) %>% summarise(counts = n(), LAD11NM = first(LAD11NM), LAD11CD = first(LAD11CD)) %>% arrange(WD16NM)

test <- wardnames %>% filter(grepl("Kensington", LAD11NM)) 

test <- EW2 %>% filter(LAD11NM == "Wandsworth")


# Chelsea
# Chelwards <- wardnames %>% filter(grepl("Kensington", LAD11NM))
# 
# Chelsea <- read_excel("FOI2017-0143.xlsx" ) %>% setNames(make.names(names(.))) %>% slice(1:18) %>%
#   mutate(Admin_ward_code = Chelwards$Admin_ward_code[c(1:10,12:17,19,18)]) %>% group_by(Ward) %>%
#   mutate(Empty = sum(Empty..unfurnished, Empty..works, Job.related, Empty..50..premium, Moorings , na.rm = TRUE),
#          LowUse = Empty + Second.Homes) %>% ungroup
# 
# Chelsea[is.na(Chelsea)] <-0
# rm(Chelwards)
# 
# Chel2 <- Chelsea %>% left_join(., MeanWardPrice) %>% left_join(., EW2) %>%
#   mutate(LowUsePerc = LowUse/WardHomes)
# 
# cor(Chel2$PrimePerc, Chel2$LowUsePerc)
# cor(Chel2$MeanPrice, Chel2$LowUsePerc)
# 
# Chel2 %>%
#   mutate(PrimePerc = PrimePerc*100, LowUsePerc = LowUsePerc*100) %>%
#   ggplot(.,aes(x= PrimePerc, LowUsePerc)) +geom_point() +
#   geom_smooth(method ="lm", se = FALSE) +
#   labs(title = "Relationship between % of Prime Sales and % Low Use",
#        x = "% of properties sold in 2016 over £1M by electoral ward",
#        y = "% of properties either empty or second homes") +
#   theme(plot.title = element_text(hjust = 0.5))  +
#   coord_cartesian(xlim = c(15,78), expand = TRUE)
# 
# 
# 
# CHELDAT <-  AG %>% filter(grepl("Kensington", LAD11NM))%>% left_join(., select(Chelsea, Admin_ward_code, LowUse, Empty)) %>% 
#   filter(WD16NM!= "Kensal Green")

#Hackney has provided Census Wards I'm not sure how useable it is. 
hackney <- read_csv("hackney.csv") %>% setNames(make.names(names(.))) %>% group_by(Exemption.Discount, Ward.Name) %>% summarise(counts = n()) %>% ungroup %>% spread(Exemption.Discount, counts, fill = 0) 


#Hammersmith 
Hammersmith <- read_excel("Hammersmith.xls", skip = 1 ) %>% filter(!is.na(Ward) ) %>% 
  bind_cols(., filter(wardnames,LAD11NM == "Hammersmith and Fulham")) %>% select(-Ward) %>%
  mutate(LowUse = `Second (B)` + `Empty Unocc`+ LTE + Premium, Empty = LowUse - `Second (B)`)
  
Hammersmith2 <- EW2 %>% filter(LAD11NM == "Hammersmith and Fulham") %>% left_join(., select(Hammersmith, Admin_ward_code, LowUse, Empty))

HAMDAT <- AG %>% filter(LAD11NM == "Hammersmith and Fulham")%>% left_join(., select(Hammersmith, Admin_ward_code, LowUse, Empty))


#Wandsworth

wardnames %>% filter(LAD11NM == "Wandsworth")

Wandsworth <- read_excel("wandsworth2.xlsx",  skip = 3 ) %>% select(1,3) %>% 
  group_by(`Ptc Wardname`) %>% summarise(Empty = sum(`Count Current Occupancy Discounts`)) %>% ungroup %>% 
  arrange(`Ptc Wardname`) %>% 
  filter(!is.na(`Ptc Wardname`)) %>% 
  bind_cols(., wardnames %>% filter(LAD11NM == "Wandsworth") %>% 
              select(Admin_ward_code)) %>%
  mutate(LowUse = Empty)

Wandsworth2 <- EW2 %>% filter(LAD11NM == "Wandsworth") %>% left_join(., select(Wandsworth, Admin_ward_code, Empty))
WANDAT <- AG %>% filter(LAD11NM == "Wandsworth")%>% left_join(., select(Wandsworth, Admin_ward_code, LowUse, Empty))


#Merton
wardnames %>% filter(LAD11NM == "Merton")
Merton <- read_excel("merton1.xlsx" )[,-2] %>%setNames(make.names(names(.))) %>% slice(-1) %>% arrange(X__1) %>%
  filter(X__1 != "Norbury", X__1!="Nightingale", X__1 !="Stonecot") %>% 
    bind_cols(., wardnames %>% filter(LAD11NM == "Merton") %>% 
              select(Admin_ward_code)) %>%
  mutate(Empty =   Disc.Class.C.Vacant.dwelling + Disc.class.C.Long.term.empty + Premium.Levy, LowUse =  Disc.Class.A.Second.home + Disc.Class.B.second.home )

MERDAT <- AG %>% filter(LAD11NM == "Merton")%>% left_join(., select(Merton, Admin_ward_code, LowUse, Empty))


#Southwark

test <- wardnames %>% filter(LAD11NM == "Southwark")

Southwark <- read_excel("southwark.xlsx" , skip = 1) %>% setNames(make.names(names(.))) %>% 
  filter(Ward.codes != "TOTALS") %>% select(-Ward.codes) %>%
  mutate(WARDS= na.locf(WARDS)) %>% group_by(WARDS) %>%
  summarise_all(sum, na.rm = TRUE) %>% ungroup %>%
  arrange(WARDS) %>%
    bind_cols(., wardnames %>% filter(LAD11NM == "Southwark") %>% 
              select(Admin_ward_code)) %>%
  mutate(Empty =   Unoccupied.and.furnished.lets....0. + Job.related.dwelling...50..discount + Second.Home...unoccupied.and.furnished...0.+Empty.and.unfurnished...0. + Levy.on.long.term.empty...50..Premium + Uninhabitable.Works.required....0., LowUse =  Empty )

Wandsworth2 <- EW2 %>% filter(LAD11NM == "Southwark") %>% left_join(., select(Southwark, Admin_ward_code, Empty))

SOUDAT <- AG %>% filter(LAD11NM == "Southwark")%>% left_join(., select(Southwark, Admin_ward_code, LowUse, Empty))

#Harrow

test <- read_excel("HarrowCTBandsLSOA. 3118795.xlsx"  )[1:4]%>% setNames(make.names(names(.))) 

#Kingston
test <- wardnames %>% filter(grepl("Kingston upon Thames", LAD11NM))

Kingston <- read_excel("Kingston1.xlsx"  )%>% setNames(make.names(names(.))) %>%
  arrange(X__1) %>% slice(1:16) %>%
  bind_cols(., wardnames %>% filter(LAD11NM == "Kingston upon Thames") %>% 
              select(Admin_ward_code)) %>%
  mutate(Empty = Empty...Furnished..0.. + Empty.Homes.Premium + LONG.TERM.EMPTY..0.. + Structural.Repair..0.., LowUse = Empty + X2nd.Home..0..)

KINDAT <- AG %>% filter(LAD11NM == "Kingston upon Thames")%>% left_join(., select(Kingston, Admin_ward_code, LowUse, Empty))


#TowerHamlets
test <- wardnames %>% filter(grepl("Tower", LAD11NM))

Tower <- read_excel("Towerhamlets.xlsx")[,c(1,3)] %>% 
  filter(!is.na(DiscClass)) %>%
  group_by(Ward, DiscClass) %>%
  summarise(count = n()) %>% ungroup %>%
  spread(., key =DiscClass, value = count, fill = 0 ) %>% 
  mutate(Empty = rowSums(.[,4:8]), LowUse = B+BE+Empty) %>% 
  slice(c(1:13, 15:17, 14, 18:20)) %>%
   bind_cols(., wardnames %>% filter(grepl("Tower", LAD11NM)))
  
TOWDAT <- AG %>% filter(grepl("Tower", LAD11NM)) %>% left_join(., select(Tower, Admin_ward_code, LowUse, Empty))


#Havering Is census wards not electoral ones
# test <- wardnames %>% filter(grepl("Havering", LAD11NM))
# 
# Havering <- read.xlsx("Havering1.xlsx")[,-2] %>% gather(key = "Ward", value = "counts",-X1) %>%
#   mutate(X1 = make.names(X1)) %>%
#   spread(key = "X1", value = "counts", fill = 0)


```


Plot Map
```{r}
AG2 <- bind_rows(CHELDAT,HAMDAT, WANDAT, LAMDAT, MERDAT, 
                 SOUDAT, KINDAT, TOWDAT, GREDAT, CAMDAT, 
                 BRODAT, HARDAT, RICDAT, HILDAT, BEXDAT,
                 SUTDAT, ISLDAT, BARKDAT, BARNDAT) %>% 
  mutate(LowUsePerc = LowUse/WardHomes*100, 
         EmptyPerc = Empty/WardHomes*100,
         EmptyPercRank = percent_rank(Empty/WardHomes))

ggplot()+ geom_polygon(data=AG2, aes(long, lat, group = group, fill = EmptyPerc), 
colour = alpha("darkred", 1/2), size = 0.1) + scale_colour_gradient2() +
  labs(title = "Current London Data") +
  theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())

SaveFig("London.png")

AG2 %>% 
  ggplot(.)+ geom_polygon( aes(long, lat, group = group, fill =sqrt(EmptyPerc)), 
colour = alpha("darkred", 1/2), size = 0.2) + scale_colour_gradient2() 

AG2 %>% 
  ggplot(.)+ geom_polygon( aes(long, lat, group = group, fill =EmptyPercRank), 
colour = alpha("darkred", 1/2), size = 0.2) + scale_colour_gradient2() +
  labs(title = "Current London Data Coloured by Percent Rank") +
  theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())

SaveFig("LondonPerc.png")

ggplot()+ geom_polygon(data=AG2, aes(long, lat, group = group, fill = LowUse/WardHomes), 
colour = alpha("darkred", 1/2), size = 0.2) + scale_colour_gradient2() 

#single borough

SingleB <- AG %>% filter(grepl("Kensington", LAD11NM))%>% 
  left_join(., select(Chelsea, Admin_ward_code, WardLowUse, WardLowUsePerc)) %>% 
  filter(WD16NM!= "Kensal Green") %>%
  mutate(WardLowUsePerc = WardLowUsePerc*100)

ggplot(SingleB) + 
  geom_polygon( aes(long, lat, group = group, fill = WardLowUsePerc), 
colour = alpha("black", 1/4), size = 0.2) + 
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = mean(SingleB$WardLowUsePerc, na.rm = TRUE)) +
  labs(title = "Kensington and Chealsea: Ward Level % Low Use", fill = "Percentage") +
  theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.title = element_text(hjust = 0.5))+
    theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())

SaveFig("RBKCLowUse.png")

ggplotly() #STFD!
#Single borough detail

Singlevis <- AG %>% filter(grepl("Kensington", LAD11NM)) %>% 
  left_join(., select(Chelsea, LSOA_CODE, LowUse, Empty, Homes), by = c("lsoa11cd"="LSOA_CODE")) %>% 
  ungroup %>%
  filter(WD16NM!= "Kensal Green") %>%
  mutate(LowUsePerc = round(LowUse/Homes.y*100), 
         EmptyPerc = round(Empty/Homes.y*100),
         EmptyPercRank = percent_rank(Empty/Homes.y))

ggplot(Singlevis, aes(long, lat, group = group, fill = LowUsePerc))+ 
  geom_polygon(colour = alpha("black", 1/2), size = 0.2) + 
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = mean(Singlevis$LowUsePerc))+
  theme(plot.title = element_text(hjust = 0.5))+
    theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())+ 
  ggtitle("Kensington and Chelsea Low use") 



Bourough2 <- Chelsea %>% ungroup %>% mutate(LowUsePerc = LowUse/Homes, 
         EmptyPerc = Empty/Homes,
         EmptyPercRank = percent_rank(Empty/Homes))

```


#Proper data Barrow

```{r}
setwd(file.path(RegionsComp, "Region North West"))

list.files()

Barrow <- read_excel("Barrow-in-FurnessExemptionsLSOA.xlsx", sheet=1) %>% setNames(make.names(names(.))) %>% .[,1:4] %>% filter(Current.Discount.Type.Code !="SINGLE") %>% group_by(LSOA_CODE, Current.Discount.Type.Code) %>%
  summarise(Empty = n()) %>% 
  spread(key=Current.Discount.Type.Code, value = Empty, fill = 0 ) %>% ungroup %>%
 mutate( LowUse = rowSums(.[-1]), Empty = LowUse-PCLB0)

Barrow2 <- Barrow %>% 
  left_join(., EW2, by = c("LSOA_CODE" = "ECODE")) %>% 
  mutate(LowUsePerc = LowUse/Homes, EmptyPerc = Empty/Homes)

Barrow3 <- Barrow %>% left_join(., AG, by = c("LSOA_CODE" = "lsoa11cd")) %>% 
  mutate(LowUsePerc = LowUse/Homes, EmptyPerc = Empty/Homes)

ggplot()+ geom_polygon(data=Barrow2, aes(long, lat, group = group, fill = PCLB0), 
colour = alpha("darkred", 1/2), size = 0.2) + scale_colour_gradient2() + ggtitle("Barrow in Furness Emptyness %")
```


```{r}
SLakeland <- read_excel("South LakelandExemptionsLSOA.XLSX", sheet=1)%>% setNames(make.names(names(.))) %>% .[,1:4] %>%
  group_by(Exemption.type, LSOA_CODE) %>% summarise(counts = n()) %>% 
  spread(key= Exemption.type, value = counts, fill = 0) %>% 
  mutate(Empty = rowSums(.[,2:9])) %>%
  left_join(., EW2, by = c("LSOA_CODE" = "ECODE")) %>% mutate(EmptyPerc = Empty/Homes)

SLakeland2 <- SLakeland %>% left_join(., AG, by = c("LSOA_CODE" = "lsoa11cd")) 

ggplot()+ geom_polygon(data=SLakeland2, aes(long, lat, group = group, fill = EmptyPerc), 
colour = alpha("darkred", 1/2), size = 0.2) + scale_colour_gradient2() + ggtitle("Barrow in Furness Emptyness %")


bind_rows(Barrow3,SLakeland2) %>%ggplot(.)+ geom_polygon( aes(long, lat, group = group, fill = EmptyPerc), 
colour = alpha("darkred", 1/2), size = 0.2) + scale_colour_gradient2() + 
  ggtitle("Cumbria Empty Percentage")+
  theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())

```

#Cornwall

```{r}

setwd(file.path(RegionsComp, "Region South West"))

list.files()

Cornwall <- read_excel("Cornwall.xlsx", sheet=1)%>% setNames(make.names(names(.))) %>% .[,1:4] %>%
  group_by(Exemption.type, LSOA_CODE) %>% summarise(counts = n()) %>% 
  spread(key= Exemption.type, value = counts, fill = 0) %>% 
  mutate(LowUse = rowSums(.[,c(FALSE,!grepl("exempt",(names(.)[-1])))])) %>%
  left_join(., EW2, by = c("LSOA_CODE" = "ECODE")) %>% group_by(Admin_ward_code)  %>%
  mutate(LowUsePerc = LowUse/Homes, WardLowUse = sum(LowUse) ,WardLowUsePerc = WardLowUse/WardHomes) %>% ungroup

Cornwall <- Cornwall %>% left_join(., MeanWardPrice) %>% mutate(ValLow = LowUse*MeanPrice)

C2 <- Cornwall %>% 
  mutate(LowUsePerc = LowUsePerc*100,
         WardLowUsePerc = WardLowUsePerc*100) %>% 
  left_join(., AG, by = c("LSOA_CODE" = "lsoa11cd"))

ggplot(C2, aes(long, lat, group = group, fill = WardLowUsePerc))+ 
  geom_polygon(colour = alpha("black", 1/4), size = 0.2) + 
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = mean(C2$WardLowUsePerc, na.rm = TRUE))+
    theme(plot.title = element_text(hjust = 0.5))+
    theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())+ 
  labs(title = "Low Use Homes in the County of Cornwall", 
       fill="Percentage")     
SaveFig("Cornwall.png")

CornCor <- Cornwall %>% 
  #filter(Admin_ward_code !="E05009195") %>% 
  summarise(x =cor(MedianPrice, WardLowUsePerc, use = 'complete.obs')) 

 
 Cornwall %>% ggplot(., aes(y=MedianPrice, x= WardLowUsePerc )) + geom_point() +
   labs(title = "Mean Price vs Low Use % by ward in Cornwall",
        x = "Low Use Percentage by Ward", 
        y = "Mean Price") +
  theme(plot.title = element_text(hjust = 0.5)) + 
    annotate("text", 
             label = paste0("Correlation =", signif(CornCor[1,1],2)), 
             x = 0.35 , y = 2.5e5, size = 5) +
   geom_smooth(method = "lm", se = FALSE)#+
#   coord_cartesian(xlim=c(0,0.2), ylim= c(1e5, 3.5e+5))
SaveFig("CornCor.png")


```


#Suffolk

```{r}

setwd(file.path(RegionsComp, "Region East of England"))
list.files()

CoastWave <- bind_rows(read.xlsx("FOI IMT178324 SuffolkCoastal.xlsx")[1:4] , read.xlsx("FOI IMT178324 Waveney.xlsx")[1:4]) %>% setNames(make.names(names(.))) %>%
  mutate(Exemption.type = Exemption.type %>% trimws %>%
           make.names %>% 
           gsub("\\.{2,}" , ".", .)) %>%
  group_by(Exemption.type, LSOA_CODE) %>% summarise(counts = n()) %>% 
  spread(key= Exemption.type, value = counts, fill = 0) %>% 
    setNames(make.names(trimws(names(.)))) %>%
    mutate(LowUse = rowSums(.[,c(5,6,13,14,16:18)]), Empty = LowUse -Second.Home.Class.A -Second.Home.Class.B) %>%
  left_join(., EW2, by = c("LSOA_CODE" = "ECODE")) %>% group_by(Admin_ward_code)  %>%
  mutate(LowUsePerc = LowUse/Homes, WardLowUse = sum(LowUse) ,WardLowUsePerc = WardLowUse/WardHomes) %>% ungroup %>% left_join(., MeanWardPrice) %>% mutate(ValLow = LowUse*MeanPrice)


CoastWave %>% left_join(., AG, by = c("LSOA_CODE" = "lsoa11cd"))  %>% 
  ggplot(.)+ 
  geom_polygon( aes(long, lat, group = group, fill = LowUsePerc), 
colour = alpha("darkred", 1/2), size = 0.2) + scale_colour_gradient2() 

#corellation
CoastWave %>% 
  #filter(Admin_ward_code !="E05009195") %>% 
  summarise(x =cor(MeanPrice, WardLowUsePerc, use = 'complete.obs'))

 CoastWave %>% ggplot(., aes(y=MeanPrice, x= WardLowUsePerc )) + geom_point() +
   labs(title = "Coastal and Waveny: Relationship between LowUse\n Percentage and Mean Price in Ward")+
  theme(plot.title = element_text(hjust = 0.5))

```



#Hull
```{r}

test <-read_excel(file.path(RegionsComp, "Region Yorkshire and The Humber",
                "KINGSTON UPON HULL%2c CITY OFDISCOUNTSLSOA.XLSX"))[-c(c(1:6)),1:4] %>%
  CleanData(.)



PlotMap(test,"Hull", variable = "WardLowUsePerc")


```

