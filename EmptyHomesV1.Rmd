---
title: "Empty Homes V1"
author: "Jonathan Bourne"
date: "10 February 2017"
output: html_document
---


man-whitney

It would have been sensible to separate council and private housing

PCLB0 is second homes, PCLC0 is long term empty, PCLC100 is empty and unfurnished up to six months and PCLD100 is undergoing major repairs up to 12 months.  

#Telegraph article on pensioners requireing mortgages
http://www.telegraph.co.uk/personal-banking/mortgages/pensioner-mortgages-boom-britains-broken-housing-market/

Mean household income 31920
https://www.ons.gov.uk/peoplepopulationandcommunity/personalandhouseholdfinances/incomeandwealth/datasets/nowcastinghouseholdincomeintheuk



#savils definitions of prime also there segmentation of the market
http://pdf.euro.savills.co.uk/spotlight-on/spotlight-on-london-housing-supply.pdf

```{r setup}
setwd( "~/Dropbox/SSE/Empty Homes/EmptyHomesCode/SubCode")
source("Setup.R")

setwd(Functions)
list.files() %>% map(source)
```

#VOA data

Council tax bands from VOA
https://www.gov.uk/government/statistics/council-tax-stock-of-properties-2016

```{r PopandHomes}
setwd(DataFolder)

CTtaxstock<- read_csv("Table_CTSOP1.1_2016.csv")

pop <- read_csv("SAPE2.csv")

EW <- inner_join(select(CTtaxstock, ECODE, ALL_PROPERTIES),select(pop, `Area Codes`, `All Ages`),
          by=c("ECODE" = "Area Codes")) %>% setNames(c("ECODE", "Homes", "Pop")) 
```

#Load the LSOA shape data for EW 

```{r}
setwd(LSOAshapedata)

shape <- readOGR(dsn = list.files(pattern = "shp"))

```



# Load Post code data

This chunk checks the exiatane of the postcode to lsoa lookup if it doesn't find it, the second part of the code is run that creates the lookup. Creating the lookup takes quite a lot of time so it is good to only have to do it once.
```{r}

if(file.exists(file.path(DataFolder,"PstCdLSOA.rds"))){
 PstCdLSOA.raw <- readRDS(file.path(DataFolder,"PstCdLSOA.rds"))
} else {
  source(file.path(CommonCode, "PostcodeLookup.R"))
}

```


Bind the ward names and LAD names to the lsoa data
```{r LAD/WARD data}
setwd(PostcodeLookups)
lsoa <- read_csv("PCD11_OA11_LSOA11_MSOA11_LAD11_EW_LU_aligned_v2.csv") %>%
  select(LSOA11CD:LAD11NMW) %>% distinct(., LSOA11CD, .keep_all = TRUE)

setwd(AddGeog)
wardnames <- read_csv("Ward_to_Local_Authority_District_to_County_to_Region_to_Country_December_2016_Lookup_in_United_Kingdom_V2.csv") %>% setNames(c("Admin_ward_code", names(.)[-1]))

#uses the dataframe from the CreateExceltemplates to get the ward names and the lsoa together
wardlsoa <- PstCdLSOA.raw %>% distinct(lsoa11cd, .keep_all = TRUE) %>% 
  select(lsoa11cd, Admin_ward_code)

EW2 <- inner_join(EW, lsoa, by = c("ECODE" = "LSOA11CD") ) %>% 
      left_join(., wardlsoa, by = c("ECODE"="lsoa11cd") ) %>% 
  left_join(., select(wardnames, Admin_ward_code, WD16NM), by = "Admin_ward_code") %>%
  group_by(Admin_ward_code) %>%
  mutate(WardHomes = sum(Homes),  WardPop = sum(Pop)) %>% ungroup
rm(wardlsoa)
rm(wardnames)
```

Convert shape file to dataframe and join in the LSOA data
```{r}

if(file.exists(file.path(DataFolder,"shapeframe.rds"))){
 AG<- readRDS(file.path(DataFolder,"shapeframe.rds"))
} else{
    setwd(LSOAshapedata)

    shape <- readOGR(dsn = list.files(pattern = "shp"))
  
    AG <- fortify(shape, region = "objectid")

    AG <- AG %>% mutate(id = as.integer(id)) %>% 
      left_join(., shape@data, by = c("id" = "objectid")) %>% 
    left_join(., EW2, by = c("lsoa11cd" = "ECODE"))
    
    saveRDS(AG, file.path(DataFolder,"shapeframe.rds"))
    }

```

#I should probably join the homes and pop at the same time I join the council tax data


#get prices

```{r}

setwd(DataFolder)

prices <-read_csv("pp-2016.csv", col_names = FALSE ) %>% 
  mutate(X4 = gsub(" ", "", X4)) %>% 
  left_join(., PstCdLSOA.raw %>% mutate(Postcode = gsub(" ", "", Postcode)), 
            by = c("X4"="Postcode")) %>% 
  filter(!is.na(lsoa11cd)) %>% mutate(Prime = X2>1e6, SuperPrime = X2>1e7)

MeanWardPrice <- prices %>% 
  group_by(Admin_ward_code) %>% 
  summarise( MeanPrice = mean(X2), 
             MedianPrice = median(X2),counts =n(),  
             Prime = sum(Prime), 
             SuperPrime = sum(SuperPrime)) %>% 
  mutate(TotPrime = Prime/sum(Prime), TotSupPrime = SuperPrime/sum(SuperPrime),
         PrimePerc = Prime/counts, SuperPrimePerc = SuperPrime/counts)

MeanWardPrice %>% ggplot(., aes(x= counts)) + geom_density()

WardDat2 <- WardDat %>% left_join(., MeanWardPrice) %>% mutate(vallow = LowUse*MeanPrice) %>%
  filter(!is.na(MeanPrice)) 


setwd(DataFolder)
list.files()

#Unnfordability at EW level salery 2014-2015
mean(prices$X2)/31920

#is mean income estimates
IncomeEst <- read_excel("1smallareaincomeestimatesdataupdate.xls", sheet = 4, skip = 4) %>%
  setNames(make.names(names(.)) %>% 
             gsub("\\.(?=\\.*$)", "", ., perl=TRUE)) #removes trailing full stop.

test2 <- prices %>% left_join(., select(EW2, ECODE, MSOA11CD), 
                              by =c("lsoa11cd"="ECODE")) %>%
  group_by(MSOA11CD) %>%
  summarise(MedianPrice = median(X2), counts = n()) %>%
  left_join(., IncomeEst, by=c("MSOA11CD"= "MSOA.code")) %>%
  mutate(Yearly.income= 52 * Total.weekly.income, ratio = MedianPrice/Yearly.income)

test2 %>% ggplot(.,aes(x=ratio)) +geom_density()

sum(test2$ratio>6)/nrow(test2)  #about 50% EW
test2 %>% filter(Region.name == "London") %>% mutate(HighRatio = ratio>6) %>%
  summarise(total = sum(HighRatio)/n())


```


# Using the full data

```{r}
#Lambeth

setwd(file.path(RegionsComp, "Region London"))

Lambethinfo <- read_excel("LambethExemptionsLSOA.xlsx")[,1:4] %>%  
    StructureData(., lowuse = c(2:5,24,25), empty =  c(4:5,24,25))


test <- Lambethinfo %>% select(LowUsePerc, WardLowUsePerc, LowuseClass, WardLowuseClass)

#Islington is exemptions only

Islingtoninfo <- read_csv("IslingtonExemptionsLSOA as at 2017 03 24.csv"  )[1:4]%>%  
    StructureData(., lowuse = c(2:11,14:18))

#Greenwhich

Greenwichinfo <- read_excel( "Royal Borough Of Greenwich.xlsx")[1:4] %>%  
    StructureData(., c(2,3,4,21,22), c(3,4,21,22))

#Camden

Camdeninfo <- read.xlsx("Camden Discounts LSOA - 20891480.xlsx" )[,1:4] %>%
 StructureData()

#Bromley

Bromleyinfo <- read.xlsx("Copy of BromleyExemptionsLSOA.xlsx")[,c(1,4:6)] %>%
  StructureData(c(6:8,29:31))

#Haringey



#Haringey is funny and has to be worked over a bit first
Haringeyinfo <- read.xlsx("Haringey_Exemptions_Discounts_LSOA.xlsx")[c(1,3,5)] 

Haringeyinfo <- data_frame(Discount = rep(Haringey$`Exemption./.Discount.type`, Haringey$Count.of.Exemptions.by.Post.Code),
           LSOA = rep(Haringey$LSOA_CODE, Haringey$Count.of.Exemptions.by.Post.Code)) %>%
  mutate( a= NA, b = NA) %>%
  StructureData(21:25)


#Sutton

Suttoninfo <- read_excel("SuttonExemptionsLSOADiscount.xlsx"  )[,c(1,4:6)] %>%
  StructureData()

#Richmond
Richmondinfo <- read_csv("Richmond_2.csv" )[1:4]%>%
  StructureData()

#Hillingdon

Hillingdoninfo <- read.xlsx("HillingdonDiscountsLSOA.XLSX" )[1:4]%>% 
  StructureData()

#Bexley

Bexleyinfo <- read.xlsx( "Bexley Exemptions.xlsx" , colNames = FALSE) %>%
StructureData

#RBKC

Chelseainfo <- read_excel( "Kensington and ChelseaDiscountsLSOA.xlsx" )[,1:4] %>%
  StructureData()

Chelseainfo2 <- read_excel( "Kensington and ChelseaDiscountsLSOA.xlsx" )[,1:4] %>%
  StructureData(full= FALSE)
colSums(Chelseainfo2[,-1])

#Barking
Barkinginfo <- read.xlsx( "Barking and DagenhamExemptionsLSOA v3.xlsx" , colNames = FALSE)[,1:4] %>%
  StructureData(c(2,3,6,7))


#Barnet

Barnetinfo <- read.xlsx( "3386297 Attachment BarnetDiscounts.xlsx"  , colNames = TRUE) %>%
  StructureData(2:8)


#Newham

Newhaminfo <- read.xlsx( "NewhamDiscountsLSOA.xlsx", colNames = TRUE)[,1:4] %>%
  StructureData(full = F)

#City of London

CoLinfo <- read_excel("City of LondonExemptionsLSOAApril2017.xlsx" )[,1:4] %>%
  StructureData(c(2,3,4,13))

#Southwark

Southwarkinfo <- read_excel("Southwark discounts.xlsx")[1:4] %>%
  StructureData(empty = -c(1,2,5))

#Croydon
CroydonInfo

#All London With missing Boroughs
PlotMap(Lambethinfo, AG)


test <-  Chelseainfo %>% left_join(., AG)

```

#Chelsea sums
```{r}

sum(Chelseainfo$LowUse)/sum(Chelseainfo$Homes)

#T test if there is a significant difference between 
v <- Chelseainfo %>% filter(LAD11CD =="E09000020")

#low-use value chelsea
sum(v$MeanPrice*v$LowUse)
ChelMeanPrice <- (sum(v$MeanPrice*v$counts)/sum(v$counts))
ChelLowMean<- sum(v$MeanPrice*v$LowUse)/sum(v$LowUse)
ChelLowMean/ChelMeanPrice
v<- rep(v$MeanPrice, times = v$LowUse)-ChelMeanPrice

#the data is not normal
plot(density(v))
#this prob not valid
t.test(v,alternative = "greater")

#do a bootstrapped mean to see if it is greater than the mean of the homes overall.
set.seed(1258)
samps <-10000

bootres <- 1:samps %>% map(~data.frame(res =sample(v, length(v), replace = T))) %>%
  bind_cols()

sum(colMeans(bootres)>0)/samps

plot(density(colMeans(bootres+ChelMeanPrice)))

#%>% setNames(paste0("samp",.x))

prices %>% filter(X14== "GREATER LONDON") %>% summarise(mean = mean(X2))
Admin_ward_code
#c("Lower Mainstream", "Mid Mainstream", "Upper Mainstream", "Prime", "Super Prime"),
ClassCountsPerWard <- prices %>% 
  filter( Admin_district_code =="E09000020") %>%
  mutate(class = cut(X2, c(0,  490,      750,   2000, 12000, Inf)*10^3, 
            labels =     c("Lower", "Mid", "Upper", "Prime", "Super"), 
             right = F)) %>%
  select(Admin_ward_code, class) %>%
  group_by(Admin_ward_code, class) %>% 
  summarise(Counts = n()) %>%
  group_by(Admin_ward_code) %>%
  mutate(WardPerc = Counts/sum(Counts)) %>%
  ungroup


test3 <- Chelseainfo %>% 
  group_by(Admin_ward_code) %>%
  summarise_all(funs(first)) %>%
  select(Admin_ward_code, WardLowUse, WardHomes) %>%
  left_join(., ClassCountsPerWard, "Admin_ward_code") %>%
  mutate(LowUseClass = WardLowUse*WardPerc,
         HomesClass = WardHomes*WardPerc) %>%
  group_by(class) %>%
  summarise(LowUseClass = sum(LowUseClass),
            HomesClass = sum(HomesClass)) %>%
  filter(complete.cases(.)) %>%
  mutate(PercOfLowUse = LowUseClass/sum(LowUseClass),
         PercOfHomes = HomesClass/sum(HomesClass),
         PercofClass = LowUseClass/HomesClass,
         `Expected Homes` = PercOfHomes*sum(LowUseClass),
         `Actual Homes` = LowUseClass)



sum(test3$LowUseClass)*test3$PercOfHomes

#Percentage over and under of what would be expected if buying was random
#The differences suggest that people are buying more expensive homes when there is no plan to live in them.
round(test3$LowUseClass/(sum(test3$LowUseClass)*test3$PercOfHomes),2)

ggplot(test3, aes(x= class, y = PercOfHomes*100)) +geom_bar(stat = "identity") + 
  labs(title = "Distribution probability of homes in each class", y = "Percentage")

test3 %>%
  select(class, `Expected Homes`, `Actual Homes`) %>%
  gather(key = "Type" , value = "Number", -class) %>%
  ggplot(., aes(x= class, y = Number, fill = Type)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Expected Number of low-use homes in each class")

test3 %>%
  mutate(`Percentage Difference` = (`Actual Homes`/`Expected Homes`)*100-100) %>%
  ggplot(., aes(x= class, y = `Percentage Difference`)) +
  geom_bar(stat = "identity") +
  labs(title = "Percentage difference between expected number of homes per class and actual")+
  coord_cartesian(ylim=c(-20,20))


```

#Chelsea Bootstrapped ratios


```{r}
 ChelPrice <- prices %>% 
  filter( Admin_district_code =="E09000020") %>%
  select(Admin_ward_code, lsoa11cd, Price =X2) %>%
  mutate(class = cut(Price, c(0,  490,      750,   2000, 12000, Inf)*10^3, 
            labels =     c("Lower", "Mid", "Upper", "Prime", "Super"), 
             right = F))


ChelseainfoWard <- Chelseainfo %>% 
  group_by(Admin_ward_code) %>%
  summarise_all(funs(first))

#bootrapps Chelsea housing stock.
set.seed(16546)
ChelseaWardLowUseStrap1 <- unique(ChelPrice$Admin_ward_code)%>% 
  map(~ ChelPrice %>% 
        filter(Admin_ward_code == .x) %>% 
  ClassStrapper(., sum((filter(ChelseainfoWard, Admin_ward_code == .x))$WardLowUse), reps = 10000) %>%
    mutate(class = as.character(class),
           Counts = as.integer(Counts),
           ID = as.integer(ID)) %>%
      setNames(c("class", paste0("Counts", .x) ,"ID"))
  ) %>%  
    Reduce(function(dtf1,dtf2) full_join(dtf1,dtf2, by = c("class", "ID")), .) %>%  
  mutate(Totals = rowSums(.[,c(-1,-3)], na.rm = TRUE),
         class = fct_relevel(class, "Upper", after = 2)) %>%
select(class, ID, Totals)

ChelseaWardHomesStrap2 <- ClassStrapper(ChelPrice, sum(ChelseainfoWard$WardHomes), 10000)

#bootrapps Chelsea housing stock.
set.seed(16540)
ChelseaWardHomesStrap1 <- unique(ChelPrice$Admin_ward_code)%>% 
  map(~ ChelPrice %>% 
        filter(Admin_ward_code == .x) %>% 
  ClassStrapper(., sum((filter(ChelseainfoWard, Admin_ward_code == .x))$WardHomes), reps = 10000) %>%
    mutate(class = as.character(class),
           Counts = as.integer(Counts),
           ID = as.integer(ID)) %>%
      setNames(c("class", paste0("Counts", .x) ,"ID"))
  ) %>%  
    Reduce(function(dtf1,dtf2) full_join(dtf1,dtf2, by = c("class", "ID")), .) %>%  
  mutate(Totals = rowSums(.[,c(-1,-3)], na.rm = TRUE),
         class = fct_relevel(class, "Upper", after = 2)) %>%
select(class, ID, Totals)



test1 <- ChelseaWardHomesStrap1  %>% left_join(., ChelseaWardLowUseStrap1, by = c("class", "ID")) %>%
  rename(LowUse = Totals.y,
         Homes = Totals.x) %>%
  group_by(ID)%>%
  mutate(ratio = LowUse/Homes,
         HomesPerc = Homes/sum(Homes),
         LowUsePerc = LowUse/sum(LowUse),
         ClassPerc = LowUse/Homes,
         ExpectedHomes = HomesPerc*sum(LowUse),
         RatioExvsAct = LowUse/ExpectedHomes) 

test1 %>% ggplot(., aes(x= class, y = ratio, fill = class)) + geom_boxplot() + 
  labs(title = "Boxplot of bootstrapped Ratios")

test1 %>%
mutate(RatioExvsAct = (RatioExvsAct-1)*100)%>% 
  ggplot(., aes(x= class, y = RatioExvsAct, fill = class)) + geom_boxplot() + 
  labs(title = "Bootstrapped difference from expected number of low-use homes", y = "% difference from expected")
SaveFig("DistributionPlot.png")

test1 %>% group_by(class) %>%
  summarise_all(funs(mean))


```


#Semi data 

The LSOA will be assigned empty and low use homes by percentage

```{r}
#ward folder
setwd(SemiLondon)
list.files()

wardnames <- EW2 %>% group_by(Admin_ward_code, WD16NM) %>% summarise(counts = n(), LAD11NM = first(LAD11NM), LAD11CD = first(LAD11CD)) %>% arrange(WD16NM)

test <- wardnames %>% filter(grepl("Kensington", LAD11NM)) 

test <- EW2 %>% filter(LAD11NM == "Wandsworth")


#Hackney has provided Census Wards I'm not sure how useable it is. 
hackney <- read_csv("hackney.csv") %>% setNames(make.names(names(.))) %>% group_by(Exemption.Discount, Ward.Name) %>% summarise(counts = n()) %>% ungroup %>% spread(Exemption.Discount, counts, fill = 0) 


#Hammersmith 
Hammersmithinfo <- read_excel("Hammersmith.xls", skip = 1 ) %>% filter(!is.na(Ward) ) %>% 
  bind_cols(., filter(wardnames,LAD11NM == "Hammersmith and Fulham")) %>% select(-Ward) %>%
  mutate(LowUse = `Second (B)` + `Empty Unocc`+ LTE + Premium, Empty = LowUse - `Second (B)`) %>%
  SemiDataStructure


#Wandsworth

Wandsworthinfo <- read_excel("wandsworth2.xlsx",  skip = 3 ) %>% select(1,3) %>% 
  group_by(`Ptc Wardname`) %>% summarise(Empty = sum(`Count Current Occupancy Discounts`)) %>% ungroup %>% 
  arrange(`Ptc Wardname`) %>% 
  filter(!is.na(`Ptc Wardname`)) %>% 
  bind_cols(., wardnames %>% filter(LAD11NM == "Wandsworth") %>% 
              select(Admin_ward_code)) %>%
  mutate(LowUse = Empty) %>%
  SemiDataStructure


#Merton

Mertoninfo <- read_excel("merton1.xlsx" )[,-2] %>%setNames(make.names(names(.))) %>% slice(-1) %>% arrange(X__1) %>%
  filter(X__1 != "Norbury", X__1!="Nightingale", X__1 !="Stonecot") %>% 
    bind_cols(., wardnames %>% filter(LAD11NM == "Merton") %>% 
              select(Admin_ward_code)) %>%
  mutate(Empty =   Disc.Class.C.Vacant.dwelling + Disc.class.C.Long.term.empty + Premium.Levy, LowUse =  Disc.Class.A.Second.home + Disc.Class.B.second.home ) %>%
  SemiDataStructure

#Harrow

test <- read_excel("HarrowCTBandsLSOA. 3118795.xlsx"  )[1:4]%>% setNames(make.names(names(.))) 

#Kingston

Kingstoninfo <- read_excel("Kingston1.xlsx"  )%>% setNames(make.names(names(.))) %>%
  arrange(X__1) %>% slice(1:16) %>%
  bind_cols(., wardnames %>% filter(LAD11NM == "Kingston upon Thames") %>% 
              select(Admin_ward_code)) %>%
  mutate(Empty = Empty...Furnished..0.. + Empty.Homes.Premium + LONG.TERM.EMPTY..0.. + Structural.Repair..0.., LowUse = Empty + X2nd.Home..0..) %>%
  SemiDataStructure


#TowerHamlets
Towerinfo <- read_excel("Towerhamlets.xlsx")[,c(1,3)] %>% 
  filter(!is.na(DiscClass)) %>%
  group_by(Ward, DiscClass) %>%
  summarise(count = n()) %>% ungroup %>%
  spread(., key =DiscClass, value = count, fill = 0 ) %>% 
  mutate(Empty = rowSums(.[,4:8]), LowUse = B+BE+Empty) %>% 
  slice(c(1:13, 15:17, 14, 18:20)) %>%
   bind_cols(., wardnames %>% filter(grepl("Tower", LAD11NM))) %>%
  SemiDataStructure

#Havering Is census wards not electoral ones
# test <- wardnames %>% filter(grepl("Havering", LAD11NM))
# 
# Havering <- read.xlsx("Havering1.xlsx")[,-2] %>% gather(key = "Ward", value = "counts",-X1) %>%
#   mutate(X1 = make.names(X1)) %>%
#   spread(key = "X1", value = "counts", fill = 0)


```

Value of low*use and total low use
```{r}

test <-  ls(pattern = "info") %>% map_df(~eval(parse(text=.x))) %>%
  group_by(Admin_ward_code) %>%
  summarise(LAD11NM = first(LAD11NM),
            MeanPrice = first(MeanPrice),
            WardLowUse = first(WardLowUse)) %>%
  group_by(LAD11NM) %>%
  summarise(totalLow = sum(MeanPrice*WardLowUse)/1e6,
            TotalEmpt = sum(WardLowUse))

sum(test$totalLow, na.rm = T)  
sum(test$TotalEmpt, na.rm = T)  
length(unique(test$LAD11NM))

```



Plot Map
```{r}

 ls(pattern = "info") %>% map_df(~eval(parse(text=.x))) %>%
  PlotMap(., filter(AG, RGN15NM=="London"), 
          filtermap = FALSE,
          title = "Map of London with all current data")
SaveFig("LondonCont.png")
 
 ls(pattern = "info") %>% map_df(~eval(parse(text=.x))) %>%
  PlotMap(., filter(AG, RGN15NM=="London"), variable = "LowuseClass", 
          filtermap = FALSE, 
          title = "Map of London by low-use class")
SaveFig("LondonDisc.png")

#single borough


Chelseainfo %>% mutate(Value = ValLow/1e6) %>%
    filter(LAD11NM == "Kensington and Chelsea") %>%
  PlotMap(., AG, variable = "Value", title = "Low-use homes in Kensington and Chelsea")

Chelseainfo %>% 
  filter(LAD11NM == "Kensington and Chelsea") %>%
  group_by(Admin_ward_code) %>%
  mutate(Value = sum(ValLow)/1e6) %>%
  PlotMap(., AG, variable = "Value", title = "Low-use homes in Kensington and Chelsea")
SaveFig("RBKCvalue.png")

Chelseainfo %>% mutate(Value = ValLow/1e6) %>%
    filter(LAD11NM == "Kensington and Chelsea") %>%
PlotMap(., AG, title = "Low-use homes in Kensington and Chelsea")
SaveFig("RBKCLowUse.png")

PlotMap(CoLinfo, AG, title = "Low-use homes in the city of London")
SaveFig("CoLLowUse.png")

PlotMap(Lambethinfo, AG, title = "Low-use homes in Lambeth")
SaveFig("LamLowUse.png")

ggplotly() #STFD!

corplotter(Chelseainfo, "MeanPrice", "WardLowUsePerc", "Mean Price vs Low Use % by ward in RBKC",
           "Low Use Percentage by Ward",
           "Mean Price")
SaveFig("ChelseaCor.png")


Chelseainfo %>% filter(WardLowUsePerc != max("WardLowUsePerc"),
                       MeanPrice != max(MeanPrice)) %>%
  corplotter(., "MeanPrice", "WardLowUsePerc", "Median Price vs Low Use % by ward in RBKC",
           "Low Use Percentage by Ward",
           "Median Price")
```

#Proper data Barrow

```{r}
setwd(file.path(RegionsComp, "Region North West"))

list.files()

Barrow <- read_excel("Barrow-in-FurnessExemptionsLSOA.xlsx", sheet=1) %>% setNames(make.names(names(.))) %>% .[,1:4] %>% filter(Current.Discount.Type.Code !="SINGLE") %>% group_by(LSOA_CODE, Current.Discount.Type.Code) %>%
  summarise(Empty = n()) %>% 
  spread(key=Current.Discount.Type.Code, value = Empty, fill = 0 ) %>% ungroup %>%
 mutate( LowUse = rowSums(.[-1]), Empty = LowUse-PCLB0)

Barrow2 <- Barrow %>% 
  left_join(., EW2, by = c("LSOA_CODE" = "ECODE")) %>% 
  mutate(LowUsePerc = LowUse/Homes, EmptyPerc = Empty/Homes)

Barrow3 <- Barrow %>% left_join(., AG, by = c("LSOA_CODE" = "lsoa11cd")) %>% 
  mutate(LowUsePerc = LowUse/Homes, EmptyPerc = Empty/Homes)

ggplot()+ geom_polygon(data=Barrow2, aes(long, lat, group = group, fill = PCLB0), 
colour = alpha("darkred", 1/2), size = 0.2) + scale_colour_gradient2() + ggtitle("Barrow in Furness Emptyness %")
```


```{r}
SLakeland <- read_excel("South LakelandExemptionsLSOA.XLSX", sheet=1)%>% setNames(make.names(names(.))) %>% .[,1:4] %>%
  group_by(Exemption.type, LSOA_CODE) %>% summarise(counts = n()) %>% 
  spread(key= Exemption.type, value = counts, fill = 0) %>% 
  mutate(Empty = rowSums(.[,2:9])) %>%
  left_join(., EW2, by = c("LSOA_CODE" = "ECODE")) %>% mutate(EmptyPerc = Empty/Homes)

SLakeland2 <- SLakeland %>% left_join(., AG, by = c("LSOA_CODE" = "lsoa11cd")) 

ggplot()+ geom_polygon(data=SLakeland2, aes(long, lat, group = group, fill = EmptyPerc), 
colour = alpha("darkred", 1/2), size = 0.2) + scale_colour_gradient2() + ggtitle("Barrow in Furness Emptyness %")


bind_rows(Barrow3,SLakeland2) %>%ggplot(.)+ geom_polygon( aes(long, lat, group = group, fill = EmptyPerc), 
colour = alpha("darkred", 1/2), size = 0.2) + scale_colour_gradient2() + 
  ggtitle("Cumbria Empty Percentage")+
  theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())

```

#Cornwall

```{r}

setwd(file.path(RegionsComp, "Region South West"))

Cornwall <- read_excel("Cornwall.xlsx", sheet=1)%>% setNames(make.names(names(.))) %>% .[,1:4] %>%
  StructureData(lowuse = c(2,23:28))

PlotMap(Cornwall, AG, title = "Lowuse in Cornwall")
SaveFig("Cornwall.png")

read_excel("Cornwall.xlsx", sheet=1)%>% setNames(make.names(names(.))) %>% .[,1:4] %>%
  StructureData(lowuse = c(2,7:16, 21:28) ) %>%
  PlotMap(., AG,title = "all empties")


corplotter(Cornwall, "MedianPrice", "WardLowUsePerc", 
           "Median Price vs Low Use % by ward in Cornwall",
           "Low Use Percentage by Ward",
           "Median Price")
SaveFig("CornCor.png")


```


#Suffolk

```{r}

setwd(file.path(RegionsComp, "Region East of England"))
list.files()

CoastWave <- bind_rows(read.xlsx("FOI IMT178324 SuffolkCoastal.xlsx")[1:4] , read.xlsx("FOI IMT178324 Waveney.xlsx")[1:4]) %>% setNames(make.names(names(.))) %>%
  mutate(Exemption.type = Exemption.type %>% trimws %>%
           make.names %>% 
           gsub("\\.{2,}" , ".", .)) %>%
  group_by(Exemption.type, LSOA_CODE) %>% summarise(counts = n()) %>% 
  spread(key= Exemption.type, value = counts, fill = 0) %>% 
    setNames(make.names(trimws(names(.)))) %>%
    mutate(LowUse = rowSums(.[,c(5,6,13,14,16:18)]), Empty = LowUse -Second.Home.Class.A -Second.Home.Class.B) %>%
  left_join(., EW2, by = c("LSOA_CODE" = "ECODE")) %>% group_by(Admin_ward_code)  %>%
  mutate(LowUsePerc = LowUse/Homes, WardLowUse = sum(LowUse) ,WardLowUsePerc = WardLowUse/WardHomes) %>% ungroup %>% left_join(., MeanWardPrice) %>% mutate(ValLow = LowUse*MeanPrice)


CoastWave %>% left_join(., AG, by = c("LSOA_CODE" = "lsoa11cd"))  %>% 
  ggplot(.)+ 
  geom_polygon( aes(long, lat, group = group, fill = LowUsePerc), 
colour = alpha("darkred", 1/2), size = 0.2) + scale_colour_gradient2() 

#corellation
CoastWave %>% 
  #filter(Admin_ward_code !="E05009195") %>% 
  summarise(x =cor(MeanPrice, WardLowUsePerc, use = 'complete.obs'))

 CoastWave %>% ggplot(., aes(y=MeanPrice, x= WardLowUsePerc )) + geom_point() +
   labs(title = "Coastal and Waveny: Relationship between LowUse\n Percentage and Mean Price in Ward")+
  theme(plot.title = element_text(hjust = 0.5))

```



#Hull
```{r}

Hull <-read_excel(file.path(RegionsComp, "Region Yorkshire and The Humber",
                "KINGSTON UPON HULL%2c CITY OFDISCOUNTSLSOA.XLSX"))[-c(c(1:6)),1:4] %>%
  StructureData(.)

PlotMap(Hull, AG, variable = "WardLowUsePerc")

corplotter(Hull, "MedianPrice", "WardLowUsePerc", 
           "Median Price vs Low Use % by ward in Hull",
           "Low Use Percentage by Ward",
           "Median Price")
```

