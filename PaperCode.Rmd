---
title: "Untitled"
author: "Jonathan Bourne"
date: "5 July 2017"
output: html_document
---


Islington should be removed and put back in when they send the correct data, it is giving a false negative

#this uses rank for distance from LAD I think it should be dist check this

#ico complaint ref
fs-506-897-47

Should type B be included? or just type A?


What's the Deal with Westminster?
Westminsters Data is very low, I want to check what codes are going on.
Westminster
PCLB00: Second home class B/A
PCLB50: 
PCLC00: Empty and unfurnsished
PCLC99: 
PCLD00: Undergoing major repairs
PCLJ50:
Single:

#Setup

```{r setup}
setwd( "~/Dropbox/SSE/Empty Homes/EmptyHomesCode/SubCode")
source("Setup.R")

setwd(Functions)
list.files() %>% map(source)

Figures <- "/home/jonno/Dropbox/Apps/ShareLaTeX/Empty Homes Write up/Figures"
source(file.path(CommonCode, "AuxdataLoad.R"))
```


#Cumbria
```{r}
setwd(file.path(RegionsComp, "Region North West"))

BarrowCUMBRIADATA <- read_excel("Barrow-in-FurnessExemptionsLSOA.xlsx", sheet=1)[1:4]%>%  
  StructureData(.,lowuse = c(2:6,8))

SLakelandCUMBRIADATA <- read_excel("South LakelandExemptionsLSOA.XLSX", sheet=1)[,1:4] %>%
    StructureData(., lowuse=2:9)

#only inlcudes postcodes so the mergeing needs to be done manually
CopelandCUMBRIADATA <- read_excel("CopelandFOI 5778 data 100517 CBC.XLSX", sheet=1) %>% 
  mutate(Postcode = sub(" ", "", Postcode)) %>%
  left_join(., PstCdLSOA.raw,  by=c("Postcode") ) %>%
  rename(Exemption.type=`Disc Type Ind`, LSOA_CODE = lsoa11cd) %>%
  select(Exemption.type, LSOA_CODE, Postcode, Country_code) %>%
  StructureData()


EdenCUMBRIADATA <- read_excel("EdenDiscountsLSOA.xlsx"  , sheet=1)[1:4] %>%  
  StructureData(.,lowuse = c(2:6,8))

CarliseCUMBRIADATA <- read_excel("FOI 5846 5983-CarlisleDiscountsLSOA June 2017.xlsx"  , sheet=1)[1:4] %>%  
  StructureData(.)

```


#Manchester

```{r}
list.files()

OldhamMANCDATA <- read_excel("FOI 10635 OldhamDiscounts LSOA.xlsx", sheet = 1 )[c(1,4:6)] %>%  
  StructureData(., c(5:6,8:11))

ManchesterMANCDATA <- read_excel("ManchesterDiscountsLSOA.xlsx", sheet = 1 )[1:4] %>%  
  StructureData(. )

RochdaleMANCDATA <- read_excel("Rochdale Both.xlsx" , sheet = 1 )[1:4] %>%  
  StructureData(., c(5,6,14,15,20:22))

TamesideMANCDATA <- read_excel("Tameside FOI 6257A2.xlsx", sheet = 1 )[1:4] %>%  
  StructureData(. )

TraffordMANCDATA <- read_excel("Trafford Exemption and Levy.xlsx" , sheet = 1 )[1:4] %>%
  filter(Exemption_type =="LEVY") %>% 
  bind_rows(.,read_excel("TraffordDiscountsLSOA.XLSX", sheet = 1 )[1:4] %>% rename(Exemption_type = Class)) %>%
  StructureData()

WiganMANCDATA <- read_excel("Wigan 5528 DISCOUNTS.xlsx", sheet = 1 )[1:4] %>%  
  StructureData(., lowuse = c(2:3, 5:9) )

#hide plot
#ls(pattern = "MANC") %>% map_df(~eval(parse(text=.x))) %>% PlotMap(., AG)


```

#SouthWest

##Cornwall

```{r}

setwd(file.path(RegionsComp, "Region South West"))

CornwallDATA <- read_excel("Cornwall.xlsx", sheet=1)%>% setNames(make.names(names(.))) %>% .[,1:4] %>%
  StructureData(lowuse = c(2,23:28))
```

##Devon

```{r}

NorthDevonDATA <- read_excel("North DevonDiscountsLSOA.XLSX", sheet=1)[1:4] %>%
  StructureData  

PlymouthDATA <- read_excel("PlymouthDiscountsLSOA.XLSX" , sheet=1)[1:4] %>%
  StructureData(lowuse = 4:8)

TorbayDATA <- read_excel("Torbay_discounts 1718551.xlsx"  , sheet=1)[1:4] %>%
  StructureData()

MidDevonDATA <- read_excel("MidDevon FOI04942Information 3.xlsx" , sheet=1)[1:4] %>%
  StructureData(c(7,10:11,20:22,26,28))

TorridgeDATA <- read_excel("FOI_TorridgeDiscountsLSOA.XLSX" , sheet=1)[1:4] %>%
  StructureData(c(4:5,7:10,13))

```

##Somerset

```{r}
NorthSomsertDATA <- read_excel("1501796 North SomersetDiscountsLSOA.xlsx" , sheet=1)[1:4] %>%
  StructureData(lowuse= 2:6)  

MendipDATA <- read_excel("Mendip 356 20170706 Response.xlsx" , sheet=1)[1:4] %>%
  StructureData(lowuse= c(37:39,52:54,65:66,69)) 

```


##Dorset

```{r}
PooleDATA <- read_excel("Copy of FOI - 265 - Bourne - PooleDiscountsLSOA.xlsx" , sheet=1)[1:4] %>%
  StructureData(lowuse = c(5,11:14,18))

ChristchurchDATA <- read_excel("Christchurch FOI17 - 0312 - Bourne - Ctax Discounts and Exemptions.xls",
                               sheet=1)[1:4] %>%
  StructureData(lowuse = c(6,12:17,20))

WeymouthDATA <-  read_excel("63687 Weymouth and PortlandDiscountsLSOA - 010817.xlsx"    ,
                               sheet=1)[1:4] %>%
  StructureData()

WestDorsetDATA <-  read_excel("47019 West DorsetDiscountsLSOA - 010817.xlsx"     ,
                               sheet=1)[1:4] %>%
  StructureData()



PurbeckDATA <-  read_excel("PurbeckDiscountsLSOA - 010817.xlsx"      ,
                               sheet=1)[1:4] %>%
  StructureData()

```


##Wiltshire

```{r}
#Wiltshire have not included everything
WiltshireDATA <- read_excel("Wiltshire ENQ07536 - Council tax discounts 2.xlsx",
                               sheet=1)[1:4] %>%
  StructureData(lowuse = 3:8)

SwindonDATA <- read_excel("Swindon - 7th July 2017 - Part 2 (Discounts).xlsx" ,
                               sheet=1)[1:4] %>%
  StructureData(2:6)
```

#East of England

##Suffolk


```{r}
setwd(file.path(RegionsComp, "Region East of England"))
list.files()


#Serparete in to the two LADS
# CoastWaveDATA <- bind_rows(read.xlsx("FOI IMT178324 SuffolkCoastal.xlsx")[1:4] , read.xlsx("FOI IMT178324 Waveney.xlsx")[1:4]) %>% setNames(make.names(names(.))) %>%
#   mutate(Exemption.type = Exemption.type %>% trimws %>%
#            make.names %>% 
#            gsub("\\.{2,}" , ".", .))  %>%
#   StructureData(., lowuse = c(5,6,13,14,16:18))

CoastSUFFDATA <- read.xlsx("FOI IMT178324 SuffolkCoastal.xlsx")[1:4] %>% setNames(make.names(names(.))) %>%
  mutate(Exemption.type = Exemption.type %>% trimws %>%
           make.names %>% 
           gsub("\\.{2,}" , ".", .))  %>%
  StructureData(.,c(5,6,11,12,14:16))

WaveneySUFFDATA <- read.xlsx("FOI IMT178324 Waveney.xlsx")[1:4] %>% setNames(make.names(names(.))) %>%
  mutate(Exemption.type = Exemption.type %>% trimws %>%
           make.names %>% 
           gsub("\\.{2,}" , ".", .))  %>%
  StructureData(., lowuse = c(5,6,13,14,16:18))

StEdmundsDATA <- read.xlsx("se FOI 146  3948502_Copy+of+St+EdmundsburyDiscountsLSOA.xlsx")[1:4] %>%
  StructureData()

ForestHeathDATA <- read.xlsx("FH FOI 146 Discounts.xlsx")[1:4] %>%
  StructureData()

IpswichDATA <- read_xlsx("IpswichDiscountsLSOA.xlsx")[1:4] %>%
   StructureData(c(2:4,6:11,13:15))

#Mid Suffolk and Babergh
#These have been combined and are just the postcodes so need to be fixed
#Missing loads of postcodes
MidSuffolkDATA <- read_excel("MidSuffolk FOI MF379 1718 Discount.xlsx") %>%
mutate(Postcode = gsub(" ", "", `Post Code`)) %>%
 left_join(.,PstCdLSOA.raw,  by=c("Postcode") ) %>%
  rename(Exemption.type=`Discount Type Description`, LSOA_CODE = lsoa11cd) %>%
  select(Exemption.type, LSOA_CODE, Postcode, Country_code, Admin_district_code) %>%
  StructureData(c(2:12,14:15))


BaberghDATA <- read_excel("Babergh FOI BF378 1718 Discount.xlsx")%>%
mutate(Postcode = gsub(" ", "", `Post Code`)) %>%
 left_join(.,PstCdLSOA.raw,  by=c("Postcode") ) %>%
  rename(Exemption.type=`Discount Type Description`, LSOA_CODE = lsoa11cd) %>%
  select(Exemption.type, LSOA_CODE, Postcode, Country_code, Admin_district_code) %>%
  StructureData(c(2:6,8:11,13:15))


```

##Norfolk
```{r}
#Broadlands is unsuable, due to lack of data collection.
#This is being checked
BroadlandsDATA <- read_excel("BroadlandDiscountsLSOA.xlsx", sheet=1)[1:4] %>%
  StructureData(4:9)

KingsLynnDATA <- read_excel("197782 - King s Lynn and West NorfolkDiscountsLSOA (2).xlsx" , sheet=1)[1:4] %>%
  StructureData(2:11)

NorthNorfolkDATA <- read_excel("North NorfolkDiscountsLSOA.XLSX" , sheet=1)[1:4] %>%
  StructureData()

BrecklandsDATA <- read_excel("BFOI-003031 BrecklandDiscountsLSOA.xlsx" , sheet=1)[1:4] %>%
  StructureData()

#they deleted the classes
SNorfolkDATA <- read_excel("SNorfolk 17-307 Discounts.xlsx"  , sheet=1)[1:4] %>%
  StructureData()

```


##Cambridge
```{r}
EastCambsDATA <- read_excel("EC FOI 130 - DISC_FOI_0_3944413b.xlsx", sheet=1)[1:4] %>%
  StructureData()


FenlandDATA <- read_excel("FL FOI 4544 DISCOUNTS.XLSX" , sheet=1)[1:4] %>%
  StructureData()

HuntingdonDATA <- read_excel("Huntingdonshire  FOI 568discounts.xlsx" , sheet=1)[1:4] %>%
  StructureData(lowuse = 2:8)

PeterboroughDATA <- read_excel("Peterborough 1707267585 completed.xlsx" , sheet=1)[1:4] %>%
  StructureData(lowuse = c(4,6:7,11))

CambridgeDATA <- read_excel("566 - Copy of Copy of CambridgeDiscountsLSOA .xlsx" , sheet=1)[1:4] %>%
  StructureData(2:5)

```

#Brightong and Hove


```{r}

setwd(file.path(RegionsComp, "Region South East"))
list.files()

BrightonDATA <- read_excel("Copy of Brighton and HoveDiscountsLSOA (4).xlsx", sheet=1)%>% .[,c(2,3:5)] %>%
  StructureData(lowuse = 2:8)
#MakeLeaflet(BournemouthDATA)

```


#Yorkshire and the Humber
```{r}
setwd(file.path(RegionsComp, "Region Yorkshire and The Humber"))

#Hull

HullDATA <-read_excel("KINGSTON UPON HULL%2c CITY OFDISCOUNTSLSOA.XLSX")[-c(c(1:6)),1:4] %>%
  StructureData(.)

#Harrowgate

HarrogateDATA <-read_excel("Harrogate DiscountsExemptionsLSOA.xlsx" )[,1:4] %>%
  StructureData(.,3:10)

#Selby
SelbyDATA <-read_excel("SelbyExemptionsLSOA.xlsx" )[,1:4]%>%
  StructureData(20:27)


# HambletonDATA <- read_excel("HDC1088.xlsx")[,1:4] %>%
#  StructureData()

ScarboroughDATA <- read_excel("FOIA 5156 Scarborough Discounts LSOA.xlsx"  )[,1:4]%>%
  StructureData(2:8)



# Middlesbrough sent the wrong data
# MiddlesbroughDATA <- read_excel( "Middlesbrough FOI RES - 011397 Discounts.xlsx"   )[,1:4]%>%
#   StructureData()

#Ryedale
RyedaleDATA <-  read_excel("Ryedale FOI 4597.xlsx")[,1:4]%>%
  StructureData(2:6)

#Crave they sent full addresses by mistake I'll do a temporary fix
CravenDATA <- read_excel("Craven Discounts.xlsx" ) %>%
  setNames(make.names(names(.))) %>%
  mutate(Postcode = str_split(Full.Property.Address, "(,)(?!.*,)", simplify = T)[,2] %>% 
           gsub(" ", "", .)) %>%
  left_join(., PstCdLSOA.raw,  by=c("Postcode") ) %>%
  rename(Exemption.type=Discount.Type.Description, LSOA_CODE = lsoa11cd) %>%
  select(Exemption.type, LSOA_CODE, Postcode, Country_code) %>%
  StructureData(c(2:5,7))

#Redcar and cleveland

RedcarDATA <-  read_excel("Redcar 0614 attachment 1.xlsx")[,1:4]%>%
  StructureData(2:10)




```

#North East

##Tyneside

```{r}

setwd(file.path(RegionsComp, "Region North East"))
list.files()
#Not sure all are there ask for confirmation
# SunderlandDATA <- read_excel("Sunderland Freedom of Informaton Request from Jonathan Bourne- 17-07-21-Discounts.xlsx"  , sheet=1)%>% .[,1:4] %>%
#   StructureData(lowuse = c(2:4,6,8:10))


NewcastleDATA <- read_excel("Newcastle upon TyneDiscountsLSOA.xlsx", sheet=1)%>% .[,c(1,3:5)] %>%
    StructureData(lowuse = 2:7)


#FOr some reason Gateshead has the wrong LAD11CD I don't know why. I have changed it to the right one but feel that perhaps I should check them all, but how?
GatesheadDATA <- read_excel("Copy of GatesheadExemptionsLSOA.XLSX"   , sheet=1)%>% .[,1:4] %>%
   StructureData(lowuse = c(2:3, 20,22:25)) %>%
  mutate(LAD11CD = ifelse(is.na(LAD11CD), NA, "E08000037"))

STynesideDATA <- read_excel("FOI 17.18456 - South Tyneside Discounts.xlsx", sheet=1)[,c(1,4:6)] %>%
    StructureData(c(32:35,38))

```


##Northumberland

```{r}
NorthumberlandDATA <- read_excel("FOI 2762 data NorthumberlandDiscounts.xlsx", sheet=1)%>% .[,1:4] %>%
    StructureData(2:7) %>%
  #The LAD code is wrong for some reason
  mutate(LAD11CD = "E06000057")

```


##Durham
```{r}
  
DurhamDATA <- read_excel("County DurhamDiscountsLSOA.XLSX" , sheet=1) %>% .[,c(1,4:6)] %>%
    StructureData()

  DarlingtonDATA <- read_excel("Darlington DBC-0809-17.xlsx" , sheet=1) %>% .[,1:4] %>%
    StructureData()

  HartlepoolDATA <- read_csv("FOI 7942 HartlepoolDiscountsLSOA.csv") %>% .[,1:4] %>%
    StructureData(2:7)
  

```


#Wales

```{r}

setwd(file.path(RegionsComp, "Region Wales"))
list.files()

#Ceredigion completed some major Student Halls which were transferred to the University, this created some very large B type transfers which artificially push the cost of second homes lower than the price of regular homes.

CeredigionDATA <- read_excel("CTAX - Ceredigion Discounts LSOA.xlsx", sheet=1)%>% .[,1:4] %>%
  StructureData(lowuse =c(8:13,15))

MonmouthDATA <- read_excel("MCC Discounts Jul 17.xlsx", sheet=1)%>% .[,1:4] %>%
  StructureData(lowuse = c(4:8))


#includes the zero class which is descibeed as 
#ZERO â€“ tis is a 50% reduction which applies after exemptions that are time limited, have expired. They are awarded on the basis that the property remains unoccupied and unfurnished.
  CarmarthenDATA <- read_excel("CarmarthenshireDiscountsLSOA.XLSX" , sheet=1)%>% .[,1:4] %>%
    StructureData()

#Strangely low numbers checking
# PowysDATA <- read_excel("PowysDiscountsLSOA.XLSX"    , sheet=1)%>% .[,1:4] %>%
#   StructureData(lowuse = c(3,5:6))

#It seems Conwy really is this short on the discounts  
ConwyDATA <- read_excel("Conwy FOI 0260-17.xlsx" , sheet=1) %>%
  rename(Postcode = geo_postcode) %>%
  mutate(Postcode = sub(" ", "", Postcode)) %>%
  left_join(., PstCdLSOA.raw,  by=c("Postcode") ) %>%
  rename(Exemption.type=disc_type_desc, LSOA_CODE = lsoa11cd) %>%
  select(Exemption.type, LSOA_CODE, Postcode, Country_code) %>%
  StructureData(lowuse = c(2,4))


DenbigshireDATA <- read_excel("FOI 2503 DenbighshireDiscountsLSOA.xlsx" , sheet=1)%>% .[,1:4] %>%
    StructureData(8:9)

WrexhamDATA <- read_csv("WrexhamDiscountsLSOA.csv" )%>% .[,1:4] %>%
    StructureData(2:5)

#Pembrokeshire didn't send all the data
PembrokeshireDATA <- read_excel("Copy of PembrokeshireDiscountsLSOA.xlsx"  , sheet=1)%>% .[,1:4] %>%
    StructureData(3)

FlintshireDATA <- read_excel("FOI R014329 FlintshireDiscounts LSOA.xlsx"  , sheet=1)%>% .[,1:4] %>%
    StructureData()


```


# London using the full data

```{r}
#Source the code from another file as it is very long
source(file.path(CommonCode, "LondonFullProcesss.R"))

#MakeLeaflet(NewhamLONDATA)

```

#Semi data 

The LSOA will be assigned empty and low use homes by percentage

```{r}
#ward folder
setwd(SemiLondon)


wardnames <- EW2 %>% group_by(Admin_ward_code, WD16NM) %>% summarise(counts = n(), LAD11NM = first(LAD11NM), LAD11CD = first(LAD11CD)) %>% arrange(WD16NM)


#Wandsworth

WandsworthLONDDATA <- read_excel("wandsworth2.xlsx",  skip = 3 ) %>% select(1,3) %>% 
  group_by(`Ptc Wardname`) %>% summarise(Empty = sum(`Count Current Occupancy Discounts`)) %>% ungroup %>% 
  arrange(`Ptc Wardname`) %>% 
  filter(!is.na(`Ptc Wardname`)) %>% 
  bind_cols(., wardnames %>% filter(LAD11NM == "Wandsworth") %>% 
              select(Admin_ward_code)) %>%
  mutate(LowUse = Empty) %>%
  SemiDataStructure


#Merton

MertonLONDATA <- read_excel("merton1.xlsx" )[,-2] %>%setNames(make.names(names(.))) %>% slice(-1) %>% arrange(X__1) %>%
  filter(X__1 != "Norbury", X__1!="Nightingale", X__1 !="Stonecot") %>% 
    bind_cols(., wardnames %>% filter(LAD11NM == "Merton") %>% 
              select(Admin_ward_code)) %>%
  mutate(Empty =   Disc.Class.C.Vacant.dwelling + Disc.class.C.Long.term.empty + Premium.Levy, LowUse =  Disc.Class.A.Second.home + Disc.Class.B.second.home ) %>%
  SemiDataStructure

#Kingston

KingstonLONDATA <- read_excel("Kingston1.xlsx"  )%>% setNames(make.names(names(.))) %>%
  arrange(X__1) %>% slice(1:16) %>%
  bind_cols(., wardnames %>% filter(LAD11NM == "Kingston upon Thames") %>% 
              select(Admin_ward_code)) %>%
  mutate(Empty = Empty...Furnished..0.. + Empty.Homes.Premium + LONG.TERM.EMPTY..0.. + Structural.Repair..0.., LowUse = Empty + X2nd.Home..0..) %>%
  SemiDataStructure


#TowerHamlets
TowerLONDATA <- read_excel("Towerhamlets.xlsx")[,c(1,3)] %>% 
  filter(!is.na(DiscClass)) %>%
  group_by(Ward, DiscClass) %>%
  summarise(count = n()) %>% ungroup %>%
  spread(., key =DiscClass, value = count, fill = 0 ) %>% 
  mutate(Empty = rowSums(.[,4:8]), LowUse = B+BE+Empty) %>% 
  slice(c(1:13, 15:17, 14, 18:20)) %>%
   bind_cols(., wardnames %>% filter(grepl("Tower", LAD11NM))) %>%
  SemiDataStructure

```

General Stats
#UK population


```{r}

#number of LUPS and Total Homes
ls(pattern = "DATA") %>% map_df(~eval(parse(text=.x))) %>% 
  filter(!is.na(LAD11NM)) %>%
  summarise(
           TotalLads = length(ls(pattern = "DATA", envir = globalenv())), #bits of other LADS cause the number to be higher than reality so the ls function is used again
           LowUse = sum(LowUse, na.rm = T),
           Homes = sum(Homes, na.rm = T),
           PercHomes = Homes/sum(EW2$Homes),
           Population = sum(Pop, na.rm= T),
           Poperc = Population/sum(EW2$Pop))

#Percentage of EW LADS
length(ls(pattern = "DATA"))/(EW2$LAD11NM %>% unique %>% length())

#check which lads are present even though I don't have data due to postcode matching
#test <- ls(pattern = "DATA") %>% map_df(~eval(parse(text=.x)))  %>% arrange(LAD11NM)
#unique(test$LAD11NM)

```


#Plot stuff
```{r}
x <-bind_rows(SouthwarkLONDATA, TowerDATA, LambethLONDATA, CoLLONDATA, NewhamLONDATA) %>% MakeLeaflet

z<- MakeLeaflet(DurhamDATA)
z
# 
setwd(basewd)
 saveWidget(z, file=file.path(basewd, "RBKC&Westminster.html"), selfcontained = TRUE )

#testSouth <- DistribCompareBootstrapper(SouthwarkLONDAls(pattern = "DATA")TA, 1652, 1000)
testSouth %>% mutate(RatioExvsAct = (RatioExvsAct-1)*100) %>% 
  ggplot(., aes(x= class, y = RatioExvsAct, fill = class)) + geom_boxplot() + 
  labs(title = "Bootstrapped difference from expected number of low-use homes", y = "% difference from expected")

ValueTtest(test)

PlotMap(BexleyLONDATA)

z <-ChelseaLONDATA %>% 
  filter(LAD11CD =="E09000020") %>% 
  bind_rows(WestminsterLONDATA) %>%
  MakeLeaflet()



```


#Overall price data 
```{r}
#Other property is massively more valuable on average than the rest of the property types
#mean value is 10 Million as such it has to be excluded
prices %>% group_by(X5) %>% 
  mutate(X2 = as.numeric(X2)) %>%
  summarise(count = n(),
            Value = sum(X2, na.rm =T),
            mean = mean(X2, na.rm = T)) %>%
mutate(countperc = (count/sum(count)),
       ValuePerc = Value/sum(Value))  

#Looking at A and B property we can see that B properties are more expensive than A type
prices %>% group_by(X15) %>% 
  mutate(X2 = as.numeric(X2)) %>%
  summarise(count = n(),
            Value = sum(X2, na.rm =T),
            mean = mean(X2, na.rm = T)) %>%
mutate(countperc = (count/sum(count)),
       ValuePerc = Value/sum(Value))  

#Other only appears in the B type sales never in A type
prices %>% 
  mutate(X2 = as.numeric(X2)) %>%
    group_by(X15, X5) %>% 
  summarise(count = n(),
            Value = sum(X2, na.rm =T),
            mean = mean(X2, na.rm = T)) %>%
  ungroup %>%
mutate(countperc = (count/sum(count)),
       ValuePerc = Value/sum(Value))  
```


#Bootstrap

Now all the data is loaded each LAD needs to be bootstrapped

```{r}


setwd(basewd)

#ExO excluding Other
#A only A type sales
#B only Btype sales

# #load full data
# BootStrapRES <-LoadAddDistribCompare("BootStrapRES.rds")
# 
# #Include only full price standard purchases
# BootStrapRESA <-LoadAddDistribCompare("BootStrapRES_A.rds", type = "A")
# 
# #Inlcude only transfers and Buy-to-let and purcheses to non-private individuals
# BootStrapRESB <-LoadAddDistribCompare("BootStrapRES_B.rds", type = "B")

#Repeat excluding all the properties classed as other
setwd(basewd)
BootStrapRESExO <-LoadAddDistribCompare("BootStrapRESExO.rds", 
                                         PropertyTypes = c("D", "S", "T", "F"))
# 
# BootStrapRESExOA <-LoadAddDistribCompare("BootStrapRESExOA.rds", type = "A", 
#                                          PropertyTypes = c("D", "S", "T", "F"))
# 
# BootStrapRESExOB <-LoadAddDistribCompare("BootStrapRESExOB.rds", type = "B", 
#                                          PropertyTypes = c("D", "S", "T", "F"))

elementnames<- names(BootStrapRESExO)

ls(pattern = "DATA")[(ls(pattern = "DATA") %>% map_dbl(~get(.x) %>%ncol))==4]


#saveRDS(BootStrapRESExO, file = "BootStrapRESExO.rds")

```


#Analyse Boostrap

land registry 
sue gambles

```{r}


#gets the list of LADs we currently have data for in alphabetical order so they can be joined to the combine
CurrentLADS <- ls(pattern = "DATA") %>%
  map_chr(~{df<- get(.x)
  df <- df %>%
  group_by(LAD11CD) %>%
  summarise(count = n())
df$LAD11CD[which.max(df$count)]}
)

#check any that are accidently not processed
ls(pattern = "DATA")[(ls(pattern = "DATA") %>% map_dbl(~.x %>% get %>% ncol))<10]

Combine1 <- BootResSummaryData(BootStrapRES) %>% mutate(LAD11CD = CurrentLADS)

Combine2 <- BootResSummaryData(BootStrapRESA) %>% mutate(LAD11CD = CurrentLADS)

Combine3 <- BootResSummaryData(BootStrapRESB) %>% mutate(LAD11CD = CurrentLADS)

#Excluding Other
Combine1ExO <- BootResSummaryData(BootStrapRESExO) %>% mutate(LAD11CD = CurrentLADS)

Combine2ExO <- BootResSummaryData(BootStrapRESExOA) %>% mutate(LAD11CD = CurrentLADS)

Combine3ExO <- BootResSummaryData(BootStrapRESExOB) %>% mutate(LAD11CD = CurrentLADS)

```

```{r}
test <- BootStrapRESExO$WestminsterLON%>% 
  group_by(class) %>%
  summarise_all(funs(mean))


test2 <- test %>%
  select(-class) %>%
  summarise_all(funs(sum)) %>%
  mutate(LowUseValue = LowUseValue/1e9)



```



#Explore results

```{r}

LADNMs <- EW2 %>% group_by(LAD11CD) %>%
  summarise(LAD11NM = first(LAD11NM))

PropertyTypes <- c("D", "S", "T", "F")

ABratio <- prices %>% 
  filter(X5 %in% PropertyTypes) %>%
  group_by(Admin_district_code, X15) %>%
  summarise(count = n(), 
            mean = mean(X2)) %>%
  rename(LAD11CD = Admin_district_code)

ABratio2 <- ABratio%>%
  select(-mean) %>%
spread(key = X15, value = count) %>%
  mutate(Countratio = B/(A+B))

ABratio3 <- ABratio%>%
  select(-count) %>%
spread(key = X15, value = mean) %>%
  mutate(Valueratio = B/(A))


ABratio4 <-  left_join(ABratio2, ABratio3, by = "LAD11CD") %>%
  left_join(LADNMs) %>%
  left_join(prices %>% 
  group_by(Admin_district_code) %>%
summarise(mean = mean(X2)) %>%
  rename(LAD11CD = Admin_district_code))



CombineAB <- Combine1ExO %>% 
  left_join(ABratio4, by = "LAD11CD") 

CombineAB %>%
  ggplot(.,aes(x= diffPerc, y = Ttest.p.value, colour = Valueratio>1)) + geom_point()

```


#Inlcuding deprivation
```{r}
setwd(file.path(basewd, "Deprivation"))
list.files()
LADDep<-read_excel("File_10_ID2015_Local_Authority_District_Summaries.xlsx", sheet = 2) %>%
  setNames(make.names(names(.)) %>% gsub("IMD...", "",.) %>% trimws ) %>%
  rename(LAD11CD = Local.Authority.District.code..2013.)

LSOADomDep<-read_excel("File_2_ID_2015_Domains_of_deprivation.xlsx" , sheet = 2) %>%
  setNames(make.names(names(.))) %>%
  setNames(make.names(names(.)) %>% gsub("Index.of.Multiple.Deprivation..IMD..", "",.) %>% trimws ) %>%
  rename(LAD11CD = Local.Authority.District.code..2013.)

LSOADep<-read_excel("File_1_ID_2015_Index_of_Multiple_Deprivation.xlsx", sheet = 2) %>%
  setNames(make.names(names(.))) %>%
  setNames(make.names(names(.)) %>% gsub("Index.of.Multiple.Deprivation..IMD..", "",.) %>% trimws ) %>%
  rename(LAD11CD = Local.Authority.District.code..2013.,
         LSOA_CODE = LSOA.code..2011.)


CombineAB <- CombineAB %>% left_join(LADDep, by = "LAD11CD")

CombineAB %>%
  ggplot(.,aes(x= diffPerc, y = Ttest.p.value, color =Rank.of.extent<100)) + geom_jitter()


#creating the empty deprivation extent
maxLSOA <- max(LSOADep$Rank..where.1.is.most.deprived.)

ExtentWeight <- LSOADep%>%
  mutate(percentile = (Rank..where.1.is.most.deprived./maxLSOA),
         perc2 = percentile-0.11,
         weight = ifelse(percentile<.11|percentile>.3,0, 0.95 - (0.95/.20)*perc2 ),
         weight = ifelse(percentile<0.11, 1, weight)) %>%
  select(LSOA_CODE, weight)

#Create the extent of deprivation of the LUPs
LUPdepExt <- ls(pattern = "DATA") %>% map_dbl(~{
df <- get(.x)
test <- df %>% 
  left_join(., ExtentWeight, by= "LSOA_CODE")  %>%
  mutate(WeightedLUP = (LowUse*weight)/sum(LowUse))

sum(test$WeightedLUP, na.rm = TRUE)
})


Combine1ExO2 <- CombineAB%>%
  mutate(LUPdepExt) 

Combine1ExO2 %>% ggplot(.,aes(x= maxPerc, y = LUPdepExt, colour = absdiff>0)) +
  geom_jitter()

Combine1ExO2 %>% ggplot(.,aes(x= maxPerc, y =Ttest.p.value, colour = LUPdepExt>0.10)) +
  geom_jitter()

```

#Model

```{r}
LADprice <- prices %>%
  filter(X5!= "O") %>%
  group_by(Admin_district_code) %>%
summarise(price = mean(X2)) %>%
  mutate(meandiff = price-mean(price),
         pricepercent = percent_rank(price))

ModelMe <- Combine1ExO2 %>%
  left_join(LADprice, by = c("LAD11CD"="Admin_district_code"))%>%
  #filter out wales
  filter(!grepl("W", LAD11CD))%>%
  select(LAD, absdiff, LUPdepExt, Extent, maxPerc,Ttest.p.value, pricepercent) %>%
  mutate(Reference = as.factor(absdiff>0) ) %>%
  #scaled so that the binomial can be interpreted
  mutate(pricepercent = scale(pricepercent),
         LUPdepExt = scale(LUPdepExt),
         maxPerc = scale(maxPerc))

#This uses the local mean so that has to be run first before the code works
# ModelMe <- Combine1ExO2 %>%
#   left_join(LADprice, by = c("LAD11CD"="Admin_district_code"))%>%
#   #filter out wales
#   filter(!grepl("W", LAD11CD))%>%
#   select(LAD11NM, absdiff, LUPdepExt, Extent, maxPerc,Ttest.p.value,  LAD11CD) %>%
#   mutate(outcome = LUPdepExt>Extent)  %>% 
#   left_join(LocalMean, by = "LAD11CD") %>%
#   left_join(LADprice, by = c("LAD11CD"="Admin_district_code")) %>%
#   mutate(priceRatio = (price/LocalMean)) %>%
#   mutate(LUPdepExt.Extent = LUPdepExt-Extent, price.LocalMean = price-LocalMean ) %>%
#   #make the Reference column properly
#   mutate(Reference = as.factor(absdiff>0) ) %>%
#   #scaled so that the binomial can be interpreted
#   mutate(pricepercent = scale(pricepercent),
#          LUPdepExt = scale(LUPdepExt),
#          maxPerc = scale(maxPerc),
#          priceRatio = scale(priceRatio))



ModelMe %>% ggplot(.,aes(x= maxPerc, y =Ttest.p.value, colour = outcome)) +
  geom_jitter()

library(rpart)
library(caret)

#classification
#three models
svm.model <- svm(Reference~ pricepercent +LUPdepExt+ maxPerc, ModelMe)
rpart.model <- rpart(Reference ~pricepercent +LUPdepExt+ maxPerc, ModelMe)
Binom <- glm(Reference~ LUPdepExt + maxPerc+ pricepercent, family=binomial(link='logit'),data=ModelMe)

linear.model <- lm(absdiff~ LUPdepExt + maxPerc+ pricepercent,data=ModelMe)


confusionMatrix(predict(svm.model, ModelMe, type = "class"), ModelMe$Reference) %>% unlist
confusionMatrix( predict(rpart.model, ModelMe, type = "class"), ModelMe$Reference)
confusionMatrix(predict(Binom, ModelMe, type = "response")>0.5 , ModelMe$Reference)


predict(linear.model, ModelMe)
summary(linear.model)
```

##perform many mode resamples and plot the results

```{r}



set.seed(1983)
test <- 1:1000 %>% map_df(~{
TestResample <- resample_partition(ModelMe, c(test = 0.3, train = 0.7))

rpart.model2 <- rpart(Reference ~pricepercent +LUPdepExt+ maxPerc, as.data.frame(TestResample$train))

Confmat <- confusionMatrix( predict(rpart.model2, as.data.frame(TestResample$test), type = "class"), as.data.frame(TestResample$test)$Reference) 

Out<- bind_cols(Confmat$overall %>% as.matrix %>%t %>% data.frame,
          Confmat$byClass %>% as.matrix %>%t %>% data.frame) %>%
  mutate(ID = .x)

}
)

test %>% ggplot(., aes(x= Accuracy)) +geom_density()

test %>%
  mutate(diff = Accuracy - AccuracyNull) %>% 
  ggplot(., aes(x= diff)) +geom_density()

t.test(test$Accuracy, test$AccuracyNull, alternative = "greater")

set.seed(1983)
test2 <- 1:1000 %>% map_df(~{
  TestResample <- resample_partition(ModelMe, c(test = 0.3, train = 0.7))

  model <- svm(Reference ~pricepercent +LUPdepExt+ maxPerc, as.data.frame(TestResample$train))

  Confmat <- confusionMatrix( predict(model, as.data.frame(TestResample$test), type = "class"),
                              as.data.frame(TestResample$test)$Reference) 

  Out<- bind_cols(Confmat$overall %>% as.matrix %>%t %>% data.frame,
          Confmat$byClass %>% as.matrix %>%t %>% data.frame) %>%
  mutate(ID = .x)

}
)

test2 %>% ggplot(., aes(x= Accuracy)) +geom_density()

test2 %>%
  mutate(diff = Accuracy - AccuracyNull) %>% 
  ggplot(., aes(x= diff)) +geom_density()

t.test(test2$Accuracy, test2$AccuracyNull, alternative = "greater")

#binom

set.seed(1983)
test3 <- 1:1000 %>% map_df(~{
  TestResample <- resample_partition(ModelMe, c(test = 0.3, train = 0.7))

  model <- glm(Reference~ LUPdepExt + maxPerc+ pricepercent, 
               family=binomial(link='logit'),
               as.data.frame(TestResample$train))

  Confmat <- confusionMatrix( predict(model, as.data.frame(TestResample$test), type = "response")>0.5,
                              as.data.frame(TestResample$test)$Reference) 

  Out<- bind_cols(Confmat$overall %>% as.matrix %>%t %>% data.frame,
          Confmat$byClass %>% as.matrix %>%t %>% data.frame,
          coefficients(model)%>% as.matrix %>%t %>% data.frame) %>%
  mutate(ID = .x)

}
)

test3 %>% ggplot(., aes(x= Accuracy)) +geom_density()

test3 %>%
  mutate(diff = Accuracy - AccuracyNull) %>% 
  ggplot(., aes(x= diff)) +geom_density()

t.test(test3$Accuracy, test3$AccuracyNull, alternative = "greater")


# 
# set.seed(1983)
# test4 <- 1:1000 %>% map_df(~{
#   TestResample <- resample_partition(ModelMe, c(test = 0.3, train = 0.7))
# 
#   model <- glm(Reference~ LUPdepExt + maxPerc+ priceRatio, 
#                family=binomial(link='logit'),
#                as.data.frame(TestResample$train))
# 
#   Confmat <- confusionMatrix( predict(model, as.data.frame(TestResample$test), type = "response")>0.5,
#                               as.data.frame(TestResample$test)$Reference) 
# 
#   Out<- bind_cols(Confmat$overall %>% as.matrix %>%t %>% data.frame,
#           Confmat$byClass %>% as.matrix %>%t %>% data.frame,
#           coefficients(model)%>% as.matrix %>%t %>% data.frame) %>%
#   mutate(ID = .x)
# 
# }
# )
# 
# test4 %>% ggplot(., aes(x= Accuracy)) +geom_density()
# 
# test4 %>%
#   mutate(diff = Accuracy - AccuracyNull) %>% 
#   ggplot(., aes(x= diff)) +geom_density()
# 
# t.test(test4$Accuracy, test4$AccuracyNull, alternative = "greater")
# 
# 
# t.test(test3$Accuracy- test3$AccuracyNull, test4$Accuracy - test4$AccuracyNull, alternative = "greater")

```

